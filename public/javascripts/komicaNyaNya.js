// ==UserScript==
// @name		にゃにゃ
// @namespace	http://komica.org/
// @version		20151011
// @description	K島本地板適用
// 綜合
// @include		*homu.komica.org/00/
// @include		*homu.komica.org/00/*.htm*
// @include		*homu.komica.org/00/*index.php*res=*
// @include		*k0.dreamhosters.com/00/
// @include		*k0.dreamhosters.com/00/*.htm*
// @include		*k0.dreamhosters.com/00/*index.php*res=*
// @exclude		*homu.komica.org/00/m/*
// @exclude		*k0.dreamhosters.com/00/m/*
// 歡樂惡搞
// @include		*homu.komica.org/12/
// @include		*homu.komica.org/12/*.htm*
// @include		*homu.komica.org/12/*index.php*res=*
// @include		*k12.dreamhosters.com/12/
// @include		*k12.dreamhosters.com/12/*.htm*
// @include		*k12.dreamhosters.com/12/*index.php*res=*
// @exclude		*homu.komica.org/12/m/*
// 影視
// @include		*homu.komica.org/04/
// @include		*homu.komica.org/04/*.htm*
// @include		*homu.komica.org/04/*index.php*res=*
// @exclude		*homu.komica.org/04/m/*
// 模型
// @include		*homu.komica.org/09/
// @include		*homu.komica.org/09/*.htm*
// @include		*homu.komica.org/09/*index.php*res=*
// @exclude		*homu.komica.org/09/m/*
// 特攝
// @include		*homu.komica.org/13/
// @include		*homu.komica.org/13/*.htm*
// @include		*homu.komica.org/13/*index.php*res=*
// @exclude		*homu.komica.org/13/m/*
// 蘿蔔
// @include		*homu.komica.org/15/
// @include		*homu.komica.org/15/*.htm*
// @include		*homu.komica.org/15/*index.php*res=*
// @exclude		*homu.komica.org/15/m/*
// 軍武
// @include		*homu.komica.org/17/
// @include		*homu.komica.org/17/*.htm*
// @include		*homu.komica.org/17/*index.php*res=*
// @exclude		*homu.komica.org/17/m/*
// 女性角色
// @include		*homu.komica.org/19/
// @include		*homu.komica.org/19/*.htm*
// @include		*homu.komica.org/19/*index.php*res=*
// @exclude		*homu.komica.org/19/m/*
// GIF
// @include		*homu.komica.org/23/
// @include		*homu.komica.org/23/*.htm*
// @include		*homu.komica.org/23/*index.php*res=*
// @exclude		*homu.komica.org/23/m/*
// 新聞
// @include		*homu.komica.org/25/
// @include		*homu.komica.org/25/*.htm*
// @include		*homu.komica.org/25/*index.php*res=*
// @exclude		*homu.komica.org/25/m/*
// 玩偶
// @include		*homu.komica.org/26/
// @include		*homu.komica.org/26/*.htm*
// @include		*homu.komica.org/26/*index.php*res=*
// @exclude		*homu.komica.org/26/m/*
// 遊戲速報
// @include		*homu.komica.org/27/
// @include		*homu.komica.org/27/*.htm*
// @include		*homu.komica.org/27/*index.php*res=*
// @exclude		*homu.komica.org/27/m/*
// 塗鴉王國
// @include		*homu.komica.org/30/
// @include		*homu.komica.org/30/*.htm*
// @include		*homu.komica.org/30/*index.php*res=*
// @exclude		*homu.komica.org/30/m/*
// 小說
// @include		*homu.komica.org/35/
// @include		*homu.komica.org/35/*.htm*
// @include		*homu.komica.org/35/*index.php*res=*
// @exclude		*homu.komica.org/35/m/*
// 電腦
// @include		*homu.komica.org/37/
// @include		*homu.komica.org/37/*.htm*
// @include		*homu.komica.org/37/*index.php*res=*
// @exclude		*homu.komica.org/37/m/*
// 男性角色
// @include		*homu.komica.org/38/
// @include		*homu.komica.org/38/*.htm*
// @include		*homu.komica.org/38/*index.php*res=*
// @exclude		*homu.komica.org/38/m/*
// 四格
// @include		*homu.komica.org/42/
// @include		*homu.komica.org/42/*.htm*
// @include		*homu.komica.org/42/*index.php*res=*
// @exclude		*homu.komica.org/42/m/*
// 布袋戲
// @include		*homu.komica.org/46/
// @include		*homu.komica.org/46/*.htm*
// @include		*homu.komica.org/46/*index.php*res=*
// @exclude		*homu.komica.org/46/m/*
// 體育綜合
// @include		*homu.komica.org/49/
// @include		*homu.komica.org/49/*.htm*
// @include		*homu.komica.org/49/*index.php*res=*
// @exclude		*homu.komica.org/49/m/*
// 網路遊戲
// @include		*homu.komica.org/52/
// @include		*homu.komica.org/52/*.htm*
// @include		*homu.komica.org/52/*index.php*res=*
// @exclude		*homu.komica.org/52/m/*
// 飲食綜合
// @include		*homu.komica.org/58/
// @include		*homu.komica.org/58/*.htm*
// @include		*homu.komica.org/58/*index.php*res=*
// @exclude		*homu.komica.org/58/m/*
// 奇幻
// @include		*homu.komica.org/60/
// @include		*homu.komica.org/60/*.htm*
// @include		*homu.komica.org/60/*index.php*res=*
// @exclude		*homu.komica.org/60/m/*
// 鋼普拉
// @include		*homu.komica.org/61/
// @include		*homu.komica.org/61/*.htm*
// @include		*homu.komica.org/61/*index.php*res=*
// @exclude		*homu.komica.org/61/m/*
// 氣象
// @include		*homu.komica.org/62/
// @include		*homu.komica.org/62/*.htm*
// @include		*homu.komica.org/62/*index.php*res=*
// @exclude		*homu.komica.org/62/m/*
// 掛圖
// @include		*homu.komica.org/64/
// @include		*homu.komica.org/64/*.htm*
// @include		*homu.komica.org/64/*index.php*res=*
// @exclude		*homu.komica.org/64/m/*
// 文化交流
// @include		*homu.komica.org/22/
// @include		*homu.komica.org/22/*.htm*
// @include		*homu.komica.org/22/*index.php*res=*
// @exclude		*homu.komica.org/22/m/*
// 寫真
// @include		*homu.komica.org/16/
// @include		*homu.komica.org/16/*.htm*
// @include		*homu.komica.org/16/*index.php*res=*
// @exclude		*homu.komica.org/16/m/*
// 中性角色
// @include		*homu.komica.org/57/
// @include		*homu.komica.org/57/*.htm*
// @include		*homu.komica.org/57/*index.php*res=*
// @exclude		*homu.komica.org/57/m/*
// 擬人
// @include		*homu.komica.org/36/
// @include		*homu.komica.org/36/*.htm*
// @include		*homu.komica.org/36/*index.php*res=*
// @exclude		*homu.komica.org/36/m/*
// 少女漫畫
// @include		*homu.komica.org/47/
// @include		*homu.komica.org/47/*.htm*
// @include		*homu.komica.org/47/*index.php*res=*
// @exclude		*homu.komica.org/47/m/*
// 音樂
// @include		*homu.komica.org/29/
// @include		*homu.komica.org/29/*.htm*
// @include		*homu.komica.org/29/*index.php*res=*
// @exclude		*homu.komica.org/29/m/*
// 紙牌
// @include		*homu.komica.org/10/
// @include		*homu.komica.org/10/*.htm*
// @include		*homu.komica.org/10/*index.php*res=*
// @exclude		*homu.komica.org/10/m/*
// FLASH
// @include		*homu.komica.org/24/
// @include		*homu.komica.org/24/*.htm*
// @include		*homu.komica.org/24/*index.php*res=*
// @exclude		*homu.komica.org/24/m/*
// MAD
// @include		*homu.komica.org/39/
// @include		*homu.komica.org/39/*.htm*
// @include		*homu.komica.org/39/*index.php*res=*
// @exclude		*homu.komica.org/39/m/*
// 素材
// @include		*homu.komica.org/44/
// @include		*homu.komica.org/44/*.htm*
// @include		*homu.komica.org/44/*index.php*res=*
// @exclude		*homu.komica.org/44/m/*
// 求圖
// @include		*homu.komica.org/45/
// @include		*homu.komica.org/45/*.htm*
// @include		*homu.komica.org/45/*index.php*res=*
// @exclude		*homu.komica.org/45/m/*
// 攝影
// @include		*homu.komica.org/50/
// @include		*homu.komica.org/50/*.htm*
// @include		*homu.komica.org/50/*index.php*res=*
// @exclude		*homu.komica.org/50/m/*
// @copyright	2014, 無名氏さん
// @author		無名氏さん
// @require		http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js
// @require		http://code.jquery.com/ui/1.11.1/jquery-ui.js
// ==/UserScript==

var defaultCfg =
  [
    0,	//0, hide title
    0,	//1, hide name
    1,	//2, expand image
    1,	//3, quote hover
    1,	//4, backquote
    1,	//5, hide switch
    0,	//6, filter
    1,	//7, quick reply
    1,	//8, hide captcha
    1,	//9, update replies
    1,	//10, update all threads
    1,	//11, top & bottom
  ];
var settingDes =
  [
    ['隱藏標題', '將每篇回覆的標題隱藏'],
    ['隱藏名稱', '將每篇回覆的名稱隱藏'],
    ['點擊顯示附圖', '在縮小的圖上點擊展開原圖'],
    ['預覽回覆內容', '滑鼠移到回覆連結上顯示回覆內容'],
    ['顯示文章所有回覆', '顯示誰回覆了這篇文章'],
    ['開關', '可以隱藏或顯示每篇回覆'],
    ['過濾', '打開或關閉文章過濾(需要開啟上一個選項)'],
    ['快速回覆', '點擊文章編號顯示回覆視窗'],
    ['隱藏驗證碼', '隱藏回覆時的驗證碼'],
    ['更新回覆', '返信頁面自動更新回覆(每一分鐘)'],
    ['統計所有文章', '統計所有文章的狀態,回覆數量'],
    ['頂端和底端按鈕', '自動移動到頁面頂端或底端的按鈕'],
  ];
var ajaxTimeout = 10000, settingTimeoutText = '伺服器沒有回應，請稍後再試';
var cfg = [], filter = [], banThread = new Object();
var statistics = new Object();

var recaptcha = false;
var recaptchaWidget = 0;
var isReplyPage = 0;
var posts = new Object();
var replies = new Object();
var threads = [], threadPostCount = new Object();
var lastHtml = '';
var idleTime = 0, lastUpdateTime = 0, title = document.title, newReplyCount = 0;
var imgOpen = 'data:image/gif;base64,R0lGODlhDgAPALMAAP//////AP8A//8AAAD//wD/AAAA/wAAAN3d3cDAwJmZmYCAgGBgYEtLS////wAAACH5BAEAAA4ALAAAAAAOAA8AAARU0MlJq7o4X7dQ+mCILAuohOdHfgpQJguQLowSA+7tKkxt4wgEbnHpkWhCAIJxNJIYyWWTSQMmqUYGDtBobJmMxhOAJZO6LM3l0/WE3oiGo0uv0x0RADs=';
var imgOpenClose = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAAoklEQVRIS2NkoBNgpJM9DCPcImNj4w3AoPaHBvfGs2fPBhAb9CQFnZGR0Q9GRkZ2kOH/////ee7cOY5Ri7CGAChOgEHkAZOEBRuMDwo+JLkd+OIMbxwBLfpPbByA1AEtwmne4LAImMp2AIPLnRhfAYNxJzAVwoMZXc9o8qZPhqVbEURMosClhqTEMPQtols+olsRRDcfURL5FBVBlFg8/JI3AL2oaht33qBLAAAAAElFTkSuQmCC';
var no0 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAABigAAAYoBM5cwWAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAedEVYdFRpdGxlACAgIE5vIDxibGFuaz4gICAgb3ZlcmxheYb92AUAAAI6SURBVFiFtZcrbxtBEIC/PanAJoEJyAMEWgFBpWFFpeW1f4GBZfvXFAWktKgsKIpZpCrQoI5BLKOSgiuYgt1r58Z7D8e3K6102tuZb3dndmbWiQhtm3NuAHwEroAT4Dj82gCvwA/gm4g8t1YqIrUd6AFTYAlIy74MMr1G/Q3wIbDeA2z7GhjWMVzMBM65PvAF+FRxcC/APfATOAMugPPw/S4y/yvwWUR+N5oAOAWeIrt5AEbAZYO5xnifsPJPwGmtCYB+BJ4DcyBrsqfRMwG2kUX06xZwZwSegeu2YKPrCFhETuIuugC8w1l4oxfXwB8j8KIPSwsIttPenh+4cwtfGHOsi80VQlMjMO8Q/hjGJ2Z8qhegg8zDPg7XBq4cU9+OZRECBkZo1DVczRubOQOAmRmsvOeHwJWv5WreDOBWDaxSwZWMNvdths9qRbunZXPOHQHfgfdqeAF8EJFfNaIr9X2S8T+lgo/tKeGWcZyZn2eJ4eAT2b+W4a9G0S4Swy1jk+ErmaKdJ4YD3KjvVyhfw5xI/OcN3l5xAy6NjhnsBqJxCnjQNcIGosjd3BBydsfwDB/my6G4IhlNuoQHxtzoKiUjm4637BYTh8CvKYfgcjoOk2xB0hW8hy9utL5yQaIm25JMwkkcsnMLj5dkQSBWlG6DT/T3AGfB5rnRVV+UBuGqsnyDz+eVdSL+no+Mt2v4Tln+lofJH3w8X+ETyws+vN5QnUvaP0zMjpI/zdp6cbLHadQEVS3F8/wvJEOg0fksZSIAAAAASUVORK5CYII=';
var no1 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAABigAAAYoBM5cwWAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAedEVYdFRpdGxlACAgIE5vIDxibGFuaz4gICAgb3ZlcmxheYb92AUAAAI8SURBVFiFtZevbxsxFMc/tjSQkMIWNC0IjAaKSsuGRseX/AUBUZq/Zqigo0NlRVHDKlWFAUsDegoaGcjAG/Ddzvfi+5Hd2dJJJ5+fP/a95/e+NiJC42bMCPgMfATOgNP0SwK8Ay/AD0ReG88pItUP9ATmAmsBafisU5te3fx18LHA9giwfrYC4yqGCbrAmD7wDfhS8uPegEfgJzAALoGL9P1DYPx34Csiv+tdAOcCz4HdLAUmAsMad00FkoD9s8B5tQugH4DvBRYCtjZeivPMBHaBRfSrFnCvDF4FrhqDi3OdCKwCf+I+vAAXcBpeG8UV8KeK4BwXF+B850f7vuXONXyl3LHNNpcZzZXBokP4U9o/U/1zfwF+klkeFXBN4Hlg+qdj7RYAI2U06Ryej5uqMSMEblVn+TlvA89jbe+Nu0XgzuvYRIPnNr677yyuqmXtsWENA2NOgAfg2utdAZ8Q+VVhufHezyx5SQWX22PCNePUqo+DyHBwhexfszgxkbXLyHDNSCxOyWTtIjIc4MZ7f7c4GZW1Acb0osGNGVJ080soEU1bH7XyIzg5TESHZzORrGZ3C7dpmlepWILFaNYp3DEWVcVIl+OdHIqJNvArlYJVOXaDtCDpCt4TJ278+ZQgyQdrSSbpn2izcw0vkWTOICRKd2lM9I8A29TnezVXjSh1xmWyPBFXz8t1IgzTo7YM2Adl+f9cTP7g8vkGV1jecOn1hvJacsTFpLij6FezplEc7XIadkFZi3A9/wuthcz7DZP/eQAAAABJRU5ErkJggg==';
var imgRight = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACKSURBVDhP5dIxCoMwGIbh1EHoKhT0CC49hIsn7Ni5Ww/h5A1ULFI6d+gN2vcLTkEhMVPxhYfwL98Us8/y+Y3qgAeu9ooowRNf3HHEpjQ0QkPSokBw7pBMOCOopSH5oIZ3a0PSw7u1oTcqeLc0NKBEUO5QgxOC09ALGrkhxab0sztc7BVZNr9/mTE/a0MsMYTFuMYAAAAASUVORK5CYII=';
var imgDown = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAB2SURBVDhPYxgFAw+YiMB4gQQQ3wbiO1AaFwbJXwdiYSDGCtiAeD4Q/ycCTwNiFiDGCzYAMTbNMLwCiIkCnEB8GoixGXIYiFmBmGgACq+HQIxsyC0gxhku+IAuEH8CYpAhb4FYDYjJBm5AfBSIbcG8UTDQgIEBAIsYLB+/HPTjAAAAAElFTkSuQmCC';
var imgGoogle = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEHSURBVDhP1dMxS0JRGMbxS+AWBeGQDu0O1SKhYy425qCDCE1COIi4BE4K0gdwE5panJ2EdleHlpJCP4CkYxJB/p9z7wWb7jluPvAb3nPP+3Lu9ejtZS5wg3zgFkUkYZVzjDHDD/4Cn2jgGJFJYIVXHOIMGqhBbVinBTV1TOWnCq3NcaAFm/SgppGp/KSgNZ3MelAOapIC1FgP6hqcosYF1DzFL+6xc3QiDfuGroJzTlBCH+FrrlGBde7wBb3aM5p4QTjwCpFJQ5vfoDu0nSfo2aOpIvIAbR6a6n8uoWdWv1wW2ixd6P6cIoMJ3nEEq5TxgXCgPvISA8ThlBj0x72GTuk8YId43gbUgj5JMzsWFQAAAABJRU5ErkJggg==';

//sprintf
//  Copyright (c) 2002 M.Inamori,All rights reserved.
//  Coded 2/26/02
//
//	sprintf()
function sprintf() {
  var argv = sprintf.arguments;
  var argc = argv.length;
  if (argc == 0)
    return "";
  var result = "";
  var format = argv[0];
  var format_length = format.length;

  var flag, width, precision;
  flag = 0;

  var index = 1;
  var mode = 0;
  var tmpresult;
  var buff;
  for (var i = 0; i < format_length; i++) {
    var c = format.charAt(i);
    switch (mode) {
      case 0:		//normal
        if (c == '%') {
          tmpresult = c;
          mode = 1;
          buff = "";
        }
        else
          result += c;
        break;
      case 1:		//after '%'
        if (c == '%') {
          result += c;
          mode = 0;
          break;
        }
        if (index >= argc)
          argv[argc++] = "";
        width = 0;
        precision = -1;
        switch (c) {
          case '-':
            flag |= 1;
            mode = 1;
            break;
          case '+':
            flag |= 2;
            mode = 1;
            break;
          case '0':
            flag |= 4;
            mode = 2;
            break;
          case ' ':
            flag |= 8;
            mode = 1;
            break;
          case '#':
            flag |= 16;
            mode = 1;
            break;
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
          case '6':
          case '7':
          case '8':
          case '9':
            width = parseInt(c);
            mode = 2;
            break;
          case '-':
            flag = 1;
            mode = 2;
            break;
          case '.':
            width = "";
            precision = 0;
            mode = 3;
            break;
          case 'd':
            result += toInteger(argv[index], flag, width, precision);
            index++;
            mode = 0;
            break;
          case 'f':
            result += toFloatingPoint(argv[index], flag, width, 6);
            index++;
            mode = 0;
            break;
          case 'e':
            result += toExponential(argv[index], flag, width, 6, 'e');
            index++;
            mode = 0;
            break;
          case 'E':
            result += toExponential(argv[index], flag, width, 6, 'E');
            index++;
            mode = 0;
            break;
          case 's':
            result += argv[index];
            index++;
            mode = 0;
            break;
          default:
            result += buff + c;
            mode = 0;
            break;
        }
        break;
      case 2:		//while defining width
        switch (c) {
          case '.':
            precision = 0;
            mode = 3;
            break;
          case '0':
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
          case '6':
          case '7':
          case '8':
          case '9':
            width = width * 10 + parseInt(c);
            mode = 2;
            break;
          case 'd':
            result += toInteger(argv[index], flag, width, precision);
            index++;
            mode = 0;
            break;
          case 'f':
            result += toFloatingPoint(argv[index], flag, width, 6);
            index++;
            mode = 0;
            break;
          case 'e':
            result += toExponential(argv[index], flag, width, 6, 'e');
            index++;
            mode = 0;
            break;
          case 'E':
            result += toExponential(argv[index], flag, width, 6, 'E');
            index++;
            mode = 0;
            break;
          case 's':
            result += toFormatString(argv[index], width, precision);
            index++;
            mode = 0;
            break;
          default:
            result += buff + c;
            mode = 0;
            break;
        }
        break;
      case 3:		//while defining precision
        switch (c) {
          case '0':
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
          case '6':
          case '7':
          case '8':
          case '9':
            precision = precision * 10 + parseInt(c);
            break;
          case 'd':
            result += toInteger(argv[index], flag, width, precision);
            index++;
            mode = 0;
            break;
          case 'f':
            result += toFloatingPoint(argv[index], flag, width, precision);
            index++;
            mode = 0;
            break;
          case 'e':
            result += toExponential(argv[index], flag, width, precision, 'e');
            index++;
            mode = 0;
            break;
          case 'E':
            result += toExponential(argv[index], flag, width, precision, 'E');
            index++;
            mode = 0;
            break;
          case 's':
            result += toFormatString(argv[index], width, precision);
            index++;
            mode = 0;
            break;
          default:
            result += buff + c;
            mode = 0;
            break;
        }
        break;
      default:
        return "error";
    }

    if (mode)
      buff += c;
  }

  return result;
}
function toInteger(n, f, w, p) {
  if (typeof n != "number") {
    if (typeof n == "string") {
      n = parseFloat(n);
      if (isNaN(n))
        n = 0;
    }
    else
      n = 0;
  }

  var str = n.toString();

  //to integer if decimal
  if (-1 < n && n < 1)
    str = "0";
  else {
    if (n < 0)
      str = str.substring(1);
    var pos_e = str.indexOf('e');
    if (pos_e != -1) {		//指数
      var exp = parseInt(str.substring(pos_e + 2));
      var pos_dot = str.indexOf('.');
      if (pos_dot == -1) {
        str = str.substring(0, pos_e) + "000000000000000000000";
        exp -= 21;
      }
      else {
        str = str.substring(0, pos_dot)
          + str.substring(pos_dot + 1, pos_e) + "00000";
        exp -= str.length - pos_dot;
      }
      for (; exp; exp--)
        str += "0";
    }
    else {
      var pos_dot = str.indexOf('.');
      if (pos_dot != -1)
        str = str.substring(0, pos_dot);
    }
  }

  //精度
  var len = str.length;
  if (len < p) {
    var c = "0";
    for (var i = p - len; i; i--)
      str = c + str;
    len = p;
  }

  //フラグの処理
  return ProcFlag(str, f, w - len, n >= 0);
}
function toFloatingPoint(n, f, w, p) {
  if (typeof n != "number") {
    if (typeof n == "string") {
      n = parseFloat(n);
      if (isNaN(n))
        n = 0;
    }
    else
      n = 0;
  }

  var bpositive = (n >= 0);
  if (!bpositive)
    n = -n;

  str = toFloatingPoint2(n, f, p);

  //フラグの処理
  return ProcFlag(str, f, w - str.length, bpositive);
}
function toFloatingPoint2(n, f, p) {
  var str = n.toString();

  //to decimal if exponential
  var pos_e = str.indexOf('e');
  if (pos_e != -1) {
    var exp = parseInt(str.substring(pos_e + 1));
    if (exp > 0) {			//指数を整数に
      var pos_dot = str.indexOf('.');
      if (pos_dot == -1) {
        str = str.substring(0, pos_e) + "000000000000000000000";
        exp -= 21;
      }
      else {
        str = str.charAt(0) + str.substring(2, pos_e) + "00000";
        exp -= str.length - 1;
      }
      for (; exp; exp--)
        str += "0";
    }
    else {					//指数を小数に
      var equive_p = exp + p;
      if (equive_p < -1)	//精度無し
        str = "0";
      else if (equive_p >= 0) {	//精度有り
        str = str.substring(0, pos_e);
        var pos_dot = str.indexOf(".");
        if (pos_dot != -1)
          str = str.charAt(0) + str.substring(2, pos_e);
        str = "000000" + str;
        for (exp += 7; exp; exp++)
          str = "0" + str;
        str = "0." + str;
      }
      else {				//微妙
        var tmp = parseFloat(str.substring(0, pos_e));
        if (tmp > 5) {	//切り上げ
          str = "0.00000";
          for (var i = exp + 7; i; i++)
            str += "0";
          str += "1";
        }
        else			//切捨て
          str = "0";
      }
    }
  }

  //精度で整形
  var len = str.length;
  var pos_dot = str.indexOf(".");
  if (pos_dot != -1) {
    var dec = len - pos_dot - 1;
    if (dec > p) {		//切る
      var tmp = parseFloat(str.charAt(pos_dot + p + 1)
        + "." + str.substring(pos_dot + p + 2));
      if (tmp > 5) {	//切り上げ
        var i;
        if (n < 1) {
          i = 2;
          while (str.charAt(i) == "0")
            i++;
          tmp = (parseInt(str.substring(i, p + 2)) + 1).toString();
          if (tmp.length > p + 2 - i) {		//桁増
            if (i == 2)
              str = "1." + tmp.substring(1);
            else
              str = str.substring(0, i - 1) + tmp;
          }
          else
            str = str.substring(0, i) + tmp;
        }
        else {
          tmp = (parseInt(str.substring(0, pos_dot) + str.substring(
              pos_dot + 1, pos_dot + p + 1)) + 1).toString();
          if (tmp.length > pos_dot + p)				//桁増
            str = tmp.substring(0, pos_dot + 1)
              + "." + tmp.substring(pos_dot + 1);
          else
            str = tmp.substring(0, pos_dot)
              + "." + tmp.substring(pos_dot);
        }
      }
      else {		//切捨て
        str = str.substring(0, p ? pos_dot + p + 1 : pos_dot);
      }
    }
    else if (dec < p) {	//"0"を充填
      for (var i = p - dec; i; i--)
        str += "0";
    }
  }
  else {
    if (p) {
      str += ".0";
      for (var i = p - 1; i; i--)
        str += "0";
    }
  }

  return str;
}
function toExponential(n, f, w, p, e) {
  if (typeof n != "number") {
    if (typeof n == "string") {
      n = parseFloat(n);
      if (isNaN(n))
        n = 0;
    }
    else
      n = 0;
  }

  var bpositive = n >= 0;
  if (!bpositive)
    n = -n;

  var str = n.toString();
  var pos_dot = str.indexOf(".");
  var pos_e = str.indexOf("e");
  var type = ((pos_e != -1) << 1) + (pos_dot != -1);
  var exp;

  //仮数部と指数部に分ける
  if (type == 0) {			//整数
    if (exp = str.length - 1)
      str = str.charAt(0) + "." + str.substring(pos_dot = 1);
  }
  else if (type == 1) {	//小数
    if (n > 10) {
      exp = pos_dot - 1;
      str = str.substring(0, 1) + "."
        + str.substring(1, pos_dot) + str.substring(pos_dot + 1);
      pos_dot = 1;
    }
    else if (n > 1)
      exp = 0;
    else {
      for (var i = 2; ; i++) {
        if (str.charAt(i) != "0") {
          exp = 1 - i;
          str = str.charAt(i) + "." + str.substring(i + 1);
          break;
        }
      }
      pos_dot = 1;
    }
  }
  else {	//指数
    exp = parseInt(str.substring(pos_e + 1));
    str = str.substring(0, pos_e);
  }

  //仮数部の整形
  str = toFloatingPoint2(parseFloat(str), f, p);

  //指数部の整形
  if (exp >= 0)
    str += e + (exp < 10 ? "+0" : "+") + exp;
  else
    str += e + (exp > -10 ? "-0" + (-exp) : exp);

  //フラグの処理
  str = ProcFlag(str, f, w - str.length, bpositive);

  return str;
}
function toFormatString(s, w, p) {
  if (typeof s != "string")
    s = s.toString();

  var len = s.length;
  if (p >= 0) {
    if (p < len) {
      s = s.substring(0, p);
      len = p;
    }
  }
  if (len < w) {
    var c = " ";
    for (var i = w - len; i; i--)
      s = c + s;
  }

  return s;
}
function ProcFlag(str, f, extra, b) {
  var minus = f & 1;
  var plus = f & 2;
  var space = f & 8;
  if (space)			//with ' '
    extra--;
  extra -= !b + plus > 0;
  if ((f & 4) > 0 && !minus) {	//with 0 and not -
    if (extra > 0) {
      var c = "0";
      for (var i = extra; i; i--)
        str = c + str;
    }
    if (!b)
      str = "-" + str;
    else if (plus)
      str = "+" + str;
  }
  else {					//without 0 or with -
    if (!b)
      str = "-" + str;
    else if (plus)
      str = "+" + str;
    var c = " ";
    if (extra > 0) {
      var c = " ";
      if (minus)
        for (var i = extra; i; i--)
          str += c;
      else
        for (var i = extra; i; i--)
          str = c + str;
    }
  }
  if (space)
    str = " " + str;

  return str;
}
//sort table
(function ($) {
  $.extend({
    tablesorter: new
      function () {
        var parsers = [], widgets = [];
        this.defaults = {
          cssHeader: "header",
          cssAsc: "headerSortUp",
          cssDesc: "headerSortDown",
          cssChildRow: "expand-child",
          sortInitialOrder: "asc",
          sortMultiSortKey: "shiftKey",
          sortForce: null,
          sortAppend: null,
          sortLocaleCompare: true,
          textExtraction: "simple",
          parsers: {},
          widgets: [],
          widgetZebra: {css: ["even", "odd"]},
          headers: {},
          widthFixed: false,
          cancelSelection: true,
          sortList: [],
          headerList: [],
          dateFormat: "us",
          decimal: '/\.|\,/g',
          onRenderHeader: null,
          selectorHeaders: 'thead th',
          debug: false
        };
        function benchmark(s, d) {
          log(s + "," + (new Date().getTime() - d.getTime()) + "ms");
        }

        this.benchmark = benchmark;
        function log(s) {
          if (typeof console != "undefined" && typeof console.debug != "undefined") {
            console.log(s);
          } else {
            alert(s);
          }
        }

        function buildParserCache(table, $headers) {
          if (table.config.debug) {
            var parsersDebug = "";
          }
          if (table.tBodies.length == 0)return;
          var rows = table.tBodies[0].rows;
          if (rows[0]) {
            var list = [], cells = rows[0].cells, l = cells.length;
            for (var i = 0; i < l; i++) {
              var p = false;
              if ($.metadata && ($($headers[i]).metadata() && $($headers[i]).metadata().sorter)) {
                p = getParserById($($headers[i]).metadata().sorter);
              } else if ((table.config.headers[i] && table.config.headers[i].sorter)) {
                p = getParserById(table.config.headers[i].sorter);
              }
              if (!p) {
                p = detectParserForColumn(table, rows, -1, i);
              }
              if (table.config.debug) {
                parsersDebug += "column:" + i + " parser:" + p.id + "\n";
              }
              list.push(p);
            }
          }
          if (table.config.debug) {
            log(parsersDebug);
          }
          return list;
        };
        function detectParserForColumn(table, rows, rowIndex, cellIndex) {
          var l = parsers.length, node = false, nodeValue = false, keepLooking = true;
          while (nodeValue == '' && keepLooking) {
            rowIndex++;
            if (rows[rowIndex]) {
              node = getNodeFromRowAndCellIndex(rows, rowIndex, cellIndex);
              nodeValue = trimAndGetNodeText(table.config, node);
              if (table.config.debug) {
                log('Checking if value was empty on row:' + rowIndex);
              }
            } else {
              keepLooking = false;
            }
          }
          for (var i = 1; i < l; i++) {
            if (parsers[i].is(nodeValue, table, node)) {
              return parsers[i];
            }
          }
          return parsers[0];
        }

        function getNodeFromRowAndCellIndex(rows, rowIndex, cellIndex) {
          return rows[rowIndex].cells[cellIndex];
        }

        function trimAndGetNodeText(config, node) {
          return $.trim(getElementText(config, node));
        }

        function getParserById(name) {
          var l = parsers.length;
          for (var i = 0; i < l; i++) {
            if (parsers[i].id.toLowerCase() == name.toLowerCase()) {
              return parsers[i];
            }
          }
          return false;
        }

        function buildCache(table) {
          if (table.config.debug) {
            var cacheTime = new Date();
          }
          var totalRows = (table.tBodies[0] && table.tBodies[0].rows.length) || 0, totalCells = (table.tBodies[0].rows[0] && table.tBodies[0].rows[0].cells.length) || 0, parsers = table.config.parsers, cache = {
            row: [],
            normalized: []
          };
          for (var i = 0; i < totalRows; ++i) {
            var c = $(table.tBodies[0].rows[i]), cols = [];
            if (c.hasClass(table.config.cssChildRow)) {
              cache.row[cache.row.length - 1] = cache.row[cache.row.length - 1].add(c);
              continue;
            }
            cache.row.push(c);
            for (var j = 0; j < totalCells; ++j) {
              cols.push(parsers[j].format(getElementText(table.config, c[0].cells[j]), table, c[0].cells[j]));
            }
            cols.push(cache.normalized.length);
            cache.normalized.push(cols);
            cols = null;
          }
          ;
          if (table.config.debug) {
            benchmark("Building cache for " + totalRows + " rows:", cacheTime);
          }
          return cache;
        };
        function getElementText(config, node) {
          var text = "";
          if (!node)return "";
          if (!config.supportsTextContent)config.supportsTextContent = node.textContent || false;
          if (config.textExtraction == "simple") {
            if (config.supportsTextContent) {
              text = node.textContent;
            } else {
              if (node.childNodes[0] && node.childNodes[0].hasChildNodes()) {
                text = node.childNodes[0].innerHTML;
              } else {
                text = node.innerHTML;
              }
            }
          } else {
            if (typeof(config.textExtraction) == "function") {
              text = config.textExtraction(node);
            } else {
              text = $(node).text();
            }
          }
          return text;
        }

        function appendToTable(table, cache) {
          if (table.config.debug) {
            var appendTime = new Date()
          }
          var c = cache, r = c.row, n = c.normalized, totalRows = n.length, checkCell = (n[0].length - 1), tableBody = $(table.tBodies[0]), rows = [];
          for (var i = 0; i < totalRows; i++) {
            var pos = n[i][checkCell];
            rows.push(r[pos]);
            if (!table.config.appender) {
              var l = r[pos].length;
              for (var j = 0; j < l; j++) {
                tableBody[0].appendChild(r[pos][j]);
              }
            }
          }
          if (table.config.appender) {
            table.config.appender(table, rows);
          }
          rows = null;
          if (table.config.debug) {
            benchmark("Rebuilt table:", appendTime);
          }
          applyWidget(table);
          setTimeout(function () {
            $(table).trigger("sortEnd");
          }, 0);
        };
        function buildHeaders(table) {
          if (table.config.debug) {
            var time = new Date();
          }
          var meta = ($.metadata) ? true : false;
          var header_index = computeTableHeaderCellIndexes(table);
          $tableHeaders = $(table.config.selectorHeaders, table).each(function (index) {
            this.column = header_index[this.parentNode.rowIndex + "-" + this.cellIndex];
            this.order = formatSortingOrder(table.config.sortInitialOrder);
            this.count = this.order;
            if (checkHeaderMetadata(this) || checkHeaderOptions(table, index))this.sortDisabled = true;
            if (checkHeaderOptionsSortingLocked(table, index))this.order = this.lockedOrder = checkHeaderOptionsSortingLocked(table, index);
            if (!this.sortDisabled) {
              var $th = $(this).addClass(table.config.cssHeader);
              if (table.config.onRenderHeader)table.config.onRenderHeader.apply($th);
            }
            table.config.headerList[index] = this;
          });
          if (table.config.debug) {
            benchmark("Built headers:", time);
            log($tableHeaders);
          }
          return $tableHeaders;
        };
        function computeTableHeaderCellIndexes(t) {
          var matrix = [];
          var lookup = {};
          var thead = t.getElementsByTagName('THEAD')[0];
          var trs = thead.getElementsByTagName('TR');
          for (var i = 0; i < trs.length; i++) {
            var cells = trs[i].cells;
            for (var j = 0; j < cells.length; j++) {
              var c = cells[j];
              var rowIndex = c.parentNode.rowIndex;
              var cellId = rowIndex + "-" + c.cellIndex;
              var rowSpan = c.rowSpan || 1;
              var colSpan = c.colSpan || 1
              var firstAvailCol;
              if (typeof(matrix[rowIndex]) == "undefined") {
                matrix[rowIndex] = [];
              }
              for (var k = 0; k < matrix[rowIndex].length + 1; k++) {
                if (typeof(matrix[rowIndex][k]) == "undefined") {
                  firstAvailCol = k;
                  break;
                }
              }
              lookup[cellId] = firstAvailCol;
              for (var k = rowIndex; k < rowIndex + rowSpan; k++) {
                if (typeof(matrix[k]) == "undefined") {
                  matrix[k] = [];
                }
                var matrixrow = matrix[k];
                for (var l = firstAvailCol; l < firstAvailCol + colSpan; l++) {
                  matrixrow[l] = "x";
                }
              }
            }
          }
          return lookup;
        }

        function checkCellColSpan(table, rows, row) {
          var arr = [], r = table.tHead.rows, c = r[row].cells;
          for (var i = 0; i < c.length; i++) {
            var cell = c[i];
            if (cell.colSpan > 1) {
              arr = arr.concat(checkCellColSpan(table, headerArr, row++));
            } else {
              if (table.tHead.length == 1 || (cell.rowSpan > 1 || !r[row + 1])) {
                arr.push(cell);
              }
            }
          }
          return arr;
        };
        function checkHeaderMetadata(cell) {
          if (($.metadata) && ($(cell).metadata().sorter === false)) {
            return true;
          }
          ;
          return false;
        }

        function checkHeaderOptions(table, i) {
          if ((table.config.headers[i]) && (table.config.headers[i].sorter === false)) {
            return true;
          }
          ;
          return false;
        }

        function checkHeaderOptionsSortingLocked(table, i) {
          if ((table.config.headers[i]) && (table.config.headers[i].lockedOrder))return table.config.headers[i].lockedOrder;
          return false;
        }

        function applyWidget(table) {
          var c = table.config.widgets;
          var l = c.length;
          for (var i = 0; i < l; i++) {
            getWidgetById(c[i]).format(table);
          }
        }

        function getWidgetById(name) {
          var l = widgets.length;
          for (var i = 0; i < l; i++) {
            if (widgets[i].id.toLowerCase() == name.toLowerCase()) {
              return widgets[i];
            }
          }
        };
        function formatSortingOrder(v) {
          if (typeof(v) != "Number") {
            return (v.toLowerCase() == "desc") ? 1 : 0;
          } else {
            return (v == 1) ? 1 : 0;
          }
        }

        function isValueInArray(v, a) {
          var l = a.length;
          for (var i = 0; i < l; i++) {
            if (a[i][0] == v) {
              return true;
            }
          }
          return false;
        }

        function setHeadersCss(table, $headers, list, css) {
          $headers.removeClass(css[0]).removeClass(css[1]);
          var h = [];
          $headers.each(function (offset) {
            if (!this.sortDisabled) {
              h[this.column] = $(this);
            }
          });
          var l = list.length;
          for (var i = 0; i < l; i++) {
            h[list[i][0]].addClass(css[list[i][1]]);
          }
        }

        function fixColumnWidth(table, $headers) {
          var c = table.config;
          if (c.widthFixed) {
            var colgroup = $('<colgroup>');
            $("tr:first td", table.tBodies[0]).each(function () {
              colgroup.append($('<col>').css('width', $(this).width()));
            });
            $(table).prepend(colgroup);
          }
          ;
        }

        function updateHeaderSortCount(table, sortList) {
          var c = table.config, l = sortList.length;
          for (var i = 0; i < l; i++) {
            var s = sortList[i], o = c.headerList[s[0]];
            o.count = s[1];
            o.count++;
          }
        }

        function multisort(table, sortList, cache) {
          if (table.config.debug) {
            var sortTime = new Date();
          }
          var dynamicExp = "var sortWrapper = function(a,b) {", l = sortList.length;
          for (var i = 0; i < l; i++) {
            var c = sortList[i][0];
            var order = sortList[i][1];
            var s = (table.config.parsers[c].type == "text") ? ((order == 0) ? makeSortFunction("text", "asc", c) : makeSortFunction("text", "desc", c)) : ((order == 0) ? makeSortFunction("numeric", "asc", c) : makeSortFunction("numeric", "desc", c));
            var e = "e" + i;
            dynamicExp += "var " + e + " = " + s;
            dynamicExp += "if(" + e + ") { return " + e + "; } ";
            dynamicExp += "else { ";
          }
          var orgOrderCol = cache.normalized[0].length - 1;
          dynamicExp += "return a[" + orgOrderCol + "]-b[" + orgOrderCol + "];";
          for (var i = 0; i < l; i++) {
            dynamicExp += "}; ";
          }
          dynamicExp += "return 0; ";
          dynamicExp += "}; ";
          if (table.config.debug) {
            benchmark("Evaling expression:" + dynamicExp, new Date());
          }
          eval(dynamicExp);
          cache.normalized.sort(sortWrapper);
          if (table.config.debug) {
            benchmark("Sorting on " + sortList.toString() + " and dir " + order + " time:", sortTime);
          }
          return cache;
        };
        function makeSortFunction(type, direction, index) {
          var a = "a[" + index + "]", b = "b[" + index + "]";
          if (type == 'text' && direction == 'asc') {
            return "(" + a + " == " + b + " ? 0 : (" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : (" + a + " < " + b + ") ? -1 : 1 )));";
          } else if (type == 'text' && direction == 'desc') {
            return "(" + a + " == " + b + " ? 0 : (" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : (" + b + " < " + a + ") ? -1 : 1 )));";
          } else if (type == 'numeric' && direction == 'asc') {
            return "(" + a + " === null && " + b + " === null) ? 0 :(" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : " + a + " - " + b + "));";
          } else if (type == 'numeric' && direction == 'desc') {
            return "(" + a + " === null && " + b + " === null) ? 0 :(" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : " + b + " - " + a + "));";
          }
        };
        function makeSortText(i) {
          return "((a[" + i + "] < b[" + i + "]) ? -1 : ((a[" + i + "] > b[" + i + "]) ? 1 : 0));";
        };
        function makeSortTextDesc(i) {
          return "((b[" + i + "] < a[" + i + "]) ? -1 : ((b[" + i + "] > a[" + i + "]) ? 1 : 0));";
        };
        function makeSortNumeric(i) {
          return "a[" + i + "]-b[" + i + "];";
        };
        function makeSortNumericDesc(i) {
          return "b[" + i + "]-a[" + i + "];";
        };
        function sortText(a, b) {
          if (table.config.sortLocaleCompare)return a.localeCompare(b);
          return ((a < b) ? -1 : ((a > b) ? 1 : 0));
        };
        function sortTextDesc(a, b) {
          if (table.config.sortLocaleCompare)return b.localeCompare(a);
          return ((b < a) ? -1 : ((b > a) ? 1 : 0));
        };
        function sortNumeric(a, b) {
          return a - b;
        };
        function sortNumericDesc(a, b) {
          return b - a;
        };
        function getCachedSortType(parsers, i) {
          return parsers[i].type;
        };
        this.construct = function (settings) {
          return this.each(function () {
            if (!this.tHead || !this.tBodies)return;
            var $this, $document, $headers, cache, config, shiftDown = 0, sortOrder;
            this.config = {};
            config = $.extend(this.config, $.tablesorter.defaults, settings);
            $this = $(this);
            $.data(this, "tablesorter", config);
            $headers = buildHeaders(this);
            this.config.parsers = buildParserCache(this, $headers);
            cache = buildCache(this);
            var sortCSS = [config.cssDesc, config.cssAsc];
            fixColumnWidth(this);
            $headers.click(function (e) {
              var totalRows = ($this[0].tBodies[0] && $this[0].tBodies[0].rows.length) || 0;
              if (!this.sortDisabled && totalRows > 0) {
                $this.trigger("sortStart");
                var $cell = $(this);
                var i = this.column;
                this.order = this.count++ % 2;
                if (this.lockedOrder)this.order = this.lockedOrder;
                if (!e[config.sortMultiSortKey]) {
                  config.sortList = [];
                  if (config.sortForce != null) {
                    var a = config.sortForce;
                    for (var j = 0; j < a.length; j++) {
                      if (a[j][0] != i) {
                        config.sortList.push(a[j]);
                      }
                    }
                  }
                  config.sortList.push([i, this.order]);
                } else {
                  if (isValueInArray(i, config.sortList)) {
                    for (var j = 0; j < config.sortList.length; j++) {
                      var s = config.sortList[j], o = config.headerList[s[0]];
                      if (s[0] == i) {
                        o.count = s[1];
                        o.count++;
                        s[1] = o.count % 2;
                      }
                    }
                  } else {
                    config.sortList.push([i, this.order]);
                  }
                }
                ;
                setTimeout(function () {
                  setHeadersCss($this[0], $headers, config.sortList, sortCSS);
                  appendToTable($this[0], multisort($this[0], config.sortList, cache));
                }, 1);
                return false;
              }
            }).mousedown(function () {
              if (config.cancelSelection) {
                this.onselectstart = function () {
                  return false
                };
                return false;
              }
            });
            $this.bind("update", function () {
              var me = this;
              setTimeout(function () {
                me.config.parsers = buildParserCache(me, $headers);
                cache = buildCache(me);
              }, 1);
            }).bind("updateCell", function (e, cell) {
              var config = this.config;
              var pos = [(cell.parentNode.rowIndex - 1), cell.cellIndex];
              cache.normalized[pos[0]][pos[1]] = config.parsers[pos[1]].format(getElementText(config, cell), cell);
            }).bind("sorton", function (e, list) {
              $(this).trigger("sortStart");
              config.sortList = list;
              var sortList = config.sortList;
              updateHeaderSortCount(this, sortList);
              setHeadersCss(this, $headers, sortList, sortCSS);
              appendToTable(this, multisort(this, sortList, cache));
            }).bind("appendCache", function () {
              appendToTable(this, cache);
            }).bind("applyWidgetId", function (e, id) {
              getWidgetById(id).format(this);
            }).bind("applyWidgets", function () {
              applyWidget(this);
            });
            if ($.metadata && ($(this).metadata() && $(this).metadata().sortlist)) {
              config.sortList = $(this).metadata().sortlist;
            }
            if (config.sortList.length > 0) {
              $this.trigger("sorton", [config.sortList]);
            }
            applyWidget(this);
          });
        };
        this.addParser = function (parser) {
          var l = parsers.length, a = true;
          for (var i = 0; i < l; i++) {
            if (parsers[i].id.toLowerCase() == parser.id.toLowerCase()) {
              a = false;
            }
          }
          if (a) {
            parsers.push(parser);
          }
          ;
        };
        this.addWidget = function (widget) {
          widgets.push(widget);
        };
        this.formatFloat = function (s) {
          var i = parseFloat(s);
          return (isNaN(i)) ? 0 : i;
        };
        this.formatInt = function (s) {
          var i = parseInt(s);
          return (isNaN(i)) ? 0 : i;
        };
        this.isDigit = function (s, config) {
          return /^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g, '')));
        };
        this.clearTableBody = function (table) {
          if ($.browser.msie) {
            function empty() {
              while (this.firstChild)this.removeChild(this.firstChild);
            }

            empty.apply(table.tBodies[0]);
          } else {
            table.tBodies[0].innerHTML = "";
          }
        };
      }
  });
  $.fn.extend({tablesorter: $.tablesorter.construct});
  var ts = $.tablesorter;
  ts.addParser({
    id: "text", is: function (s) {
      return true;
    }, format: function (s) {
      return $.trim(s.toLocaleLowerCase());
    }, type: "text"
  });
  ts.addParser({
    id: "digit", is: function (s, table) {
      var c = table.config;
      return $.tablesorter.isDigit(s, c);
    }, format: function (s) {
      return $.tablesorter.formatFloat(s);
    }, type: "numeric"
  });
  ts.addParser({
    id: "currency", is: function (s) {
      return /^[£$€?.]/.test(s);
    }, format: function (s) {
      return $.tablesorter.formatFloat(s.replace(new RegExp(/[£$€]/g), ""));
    }, type: "numeric"
  });
  ts.addParser({
    id: "ipAddress", is: function (s) {
      return /^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s);
    }, format: function (s) {
      var a = s.split("."), r = "", l = a.length;
      for (var i = 0; i < l; i++) {
        var item = a[i];
        if (item.length == 2) {
          r += "0" + item;
        } else {
          r += item;
        }
      }
      return $.tablesorter.formatFloat(r);
    }, type: "numeric"
  });
  ts.addParser({
    id: "url", is: function (s) {
      return /^(https?|ftp|file):\/\/$/.test(s);
    }, format: function (s) {
      return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//), ''));
    }, type: "text"
  });
  ts.addParser({
    id: "isoDate", is: function (s) {
      return /^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s);
    }, format: function (s) {
      return $.tablesorter.formatFloat((s != "") ? new Date(s.replace(new RegExp(/-/g), "/")).getTime() : "0");
    }, type: "numeric"
  });
  ts.addParser({
    id: "percent", is: function (s) {
      return /\%$/.test($.trim(s));
    }, format: function (s) {
      return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g), ""));
    }, type: "numeric"
  });
  ts.addParser({
    id: "usLongDate", is: function (s) {
      return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/));
    }, format: function (s) {
      return $.tablesorter.formatFloat(new Date(s).getTime());
    }, type: "numeric"
  });
  ts.addParser({
    id: "shortDate", is: function (s) {
      return /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s);
    }, format: function (s, table) {
      var c = table.config;
      s = s.replace(/\-/g, "/");
      if (c.dateFormat == "us") {
        s = s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, "$3/$1/$2");
      } else if (c.dateFormat == "uk") {
        s = s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, "$3/$2/$1");
      } else if (c.dateFormat == "dd/mm/yy" || c.dateFormat == "dd-mm-yy") {
        s = s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/, "$1/$2/$3");
      }
      return $.tablesorter.formatFloat(new Date(s).getTime());
    }, type: "numeric"
  });
  ts.addParser({
    id: "time", is: function (s) {
      return /^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s);
    }, format: function (s) {
      return $.tablesorter.formatFloat(new Date("2000/01/01 " + s).getTime());
    }, type: "numeric"
  });
  ts.addParser({
    id: "metadata", is: function (s) {
      return false;
    }, format: function (s, table, cell) {
      var c = table.config, p = (!c.parserMetadataName) ? 'sortValue' : c.parserMetadataName;
      return $(cell).metadata()[p];
    }, type: "numeric"
  });
  ts.addWidget({
    id: "zebra", format: function (table) {
      if (table.config.debug) {
        var time = new Date();
      }
      var $tr, row = -1, odd;
      $("tr:visible", table.tBodies[0]).each(function (i) {
        $tr = $(this);
        if (!$tr.hasClass(table.config.cssChildRow))row++;
        odd = (row % 2 == 0);
        $tr.removeClass(table.config.widgetZebra.css[odd ? 0 : 1]).addClass(table.config.widgetZebra.css[odd ? 1 : 0])
      });
      if (table.config.debug) {
        $.tablesorter.benchmark("Applying Zebra widget", time);
      }
    }
  });
})(jQuery);
//ignore
$.fn.ignore = function (sel) {
  return this.clone().find(sel).remove().end();
};
//.insertAtCaret
$.fn.insertAtCaret = function (myValue) {
  return this.each(function () {
    var me = this;
    if (document.selection) // IE
    {
      me.focus();
      sel = document.selection.createRange();
      sel.text = myValue;
      me.focus();
    }
    else if (me.selectionStart || me.selectionStart == '0')　// Real browsers
    {
      var startPos = me.selectionStart, endPos = me.selectionEnd, scrollTop = me.scrollTop;
      me.value = me.value.substring(0, startPos) + myValue + me.value.substring(endPos, me.value.length);
      me.focus();
      me.selectionStart = startPos + myValue.length;
      me.selectionEnd = startPos + myValue.length;
      me.scrollTop = scrollTop;
    }
    else {
      me.value += myValue;
      me.focus();
    }
  });
};
/**
 * Convert an image
 * to a base64 string
 * @param  {String}   url
 * @param  {Function} callback
 * @param  {String}   [outputFormat=image/png]
 */
function convertImgToBase64(url, callback, outputFormat) {
  var canvas = document.createElement('CANVAS'),
    ctx = canvas.getContext('2d'),
    img = new Image;
  img.crossOrigin = 'Anonymous';
  img.onload = function () {
    var dataURL;
    canvas.height = img.height;
    canvas.width = img.width;
    ctx.drawImage(img, 0, 0);
    dataURL = canvas.toDataURL(outputFormat);
    callback.call(this, dataURL);
    canvas = null;
  };
  img.src = url;
}
/*!
 * jQuery Cookie Plugin v1.4.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2006, 2014 Klaus Hartl
 * Released under the MIT license
 */
(function (factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD
    define(['jquery'], factory);
  }
  else if (typeof exports === 'object') {
    // CommonJS
    factory(require('jquery'));
  }
  else {
    // Browser globals
    factory(jQuery);
  }
}
(function ($) {
  var pluses = /\+/g;

  function encode(s) {
    return config.raw ? s : encodeURIComponent(s);
  }

  function decode(s) {
    return config.raw ? s : decodeURIComponent(s);
  }

  function stringifyCookieValue(value) {
    return encode(config.json ? JSON.stringify(value) : String(value));
  }

  function parseCookieValue(s) {
    if (s.indexOf('"') === 0) {
      // This is a quoted cookie as according to RFC2068, unescape...
      s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
    }

    try {
      // Replace server-side written pluses with spaces.
      // If we can't decode the cookie, ignore it, it's unusable.
      // If we can't parse the cookie, ignore it, it's unusable.
      s = decodeURIComponent(s.replace(pluses, ' '));
      return config.json ? JSON.parse(s) : s;
    } catch (e) {
    }
  }

  function read(s, converter) {
    var value = config.raw ? s : parseCookieValue(s);
    return $.isFunction(converter) ? converter(value) : value;
  }

  var config = $.cookie = function (key, value, options) {
    // Write
    if (arguments.length > 1 && !$.isFunction(value)) {
      options = $.extend({}, config.defaults, options);
      if (typeof options.expires === 'number') {
        var days = options.expires, t = options.expires = new Date();
        t.setTime(+t + days * 864e+5);
      }

      return (document.cookie =
        [
          encode(key), '=', stringifyCookieValue(value),
          options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
          options.path ? '; path=' + options.path : '',
          options.domain ? '; domain=' + options.domain : '',
          options.secure ? '; secure' : ''
        ].join(''));
    }

    // Read

    var result = key ? undefined : {};

    // To prevent the for loop in the first place assign an empty array
    // in case there are no cookies at all. Also prevents odd result when
    // calling $.cookie().
    var cookies = document.cookie ? document.cookie.split('; ') : [];
    for (var i = 0, l = cookies.length; i < l; i++) {
      var parts = cookies[i].split('=');
      var name = decode(parts.shift());
      var cookie = parts.join('=');

      if (key && key === name) {
        // If second argument (value) is a function it's a converter...
        result = read(cookie, value);
        break;
      }

      // Prevent storing a cookie that we couldn't decode.
      if (!key && (cookie = read(cookie)) !== undefined) {
        result[name] = cookie;
      }
    }
    return result;
  };

  config.defaults = {};
  $.removeCookie = function (key, options) {
    if ($.cookie(key) === undefined) {
      return false;
    }

    // Must not alter options, thus extending a fresh object...
    $.cookie(key, '', $.extend({}, options, {expires: -1}));
    return !$.cookie(key);
  };
}));
//jquery sidr
(function (e) {
  var t = !1, i = !1, n = {
    isUrl: function (e) {
      var t = RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$", "i");
      return t.test(e) ? !0 : !1
    }, loadContent: function (e, t) {
      e.html(t)
    }, addPrefix: function (e) {
      var t = e.attr("id"), i = e.attr("class");
      "string" == typeof t && "" !== t && e.attr("id", t.replace(/([A-Za-z0-9_.\-]+)/g, "sidr-id-$1")), "string" == typeof i && "" !== i && "sidr-inner" !== i && e.attr("class", i.replace(/([A-Za-z0-9_.\-]+)/g, "sidr-class-$1")), e.removeAttr("style")
    }, execute: function (n, s, a) {
      "function" == typeof s ? (a = s, s = "sidr") : s || (s = "sidr");
      var r, d, l, c = e("#" + s), u = e(c.data("body")), f = e("html"), p = c.outerWidth(!0), g = c.data("speed"), h = c.data("side"), m = c.data("displace"), v = c.data("onOpen"), y = c.data("onClose"), x = "sidr" === s ? "sidr-open" : "sidr-open " + s + "-open";
      if ("open" === n || "toggle" === n && !c.is(":visible")) {
        if (c.is(":visible") || t)return;
        if (i !== !1)return o.close(i, function () {
          o.open(s)
        }), void 0;
        t = !0, "left" === h ? (r = {left: p + "px"}, d = {left: "0px"}) : (r = {right: p + "px"}, d = {right: "0px"}), u.is("body") && (l = f.scrollTop(), f.css("overflow-x", "hidden").scrollTop(l)), m ? u.addClass("sidr-animating").css({
          width: u.width(),
          position: "absolute"
        }).animate(r, g, function () {
          e(this).addClass(x)
        }) : setTimeout(function () {
          e(this).addClass(x)
        }, g), c.css("display", "block").animate(d, g, function () {
          t = !1, i = s, "function" == typeof a && a(s), u.removeClass("sidr-animating")
        }), v()
      } else {
        if (!c.is(":visible") || t)return;
        t = !0, "left" === h ? (r = {left: 0}, d = {left: "-" + p + "px"}) : (r = {right: 0}, d = {right: "-" + p + "px"}), u.is("body") && (l = f.scrollTop(), f.removeAttr("style").scrollTop(l)), u.addClass("sidr-animating").animate(r, g).removeClass(x), c.animate(d, g, function () {
          c.removeAttr("style").hide(), u.removeAttr("style"), e("html").removeAttr("style"), t = !1, i = !1, "function" == typeof a && a(s), u.removeClass("sidr-animating")
        }), y()
      }
    }
  }, o = {
    open: function (e, t) {
      n.execute("open", e, t)
    }, close: function (e, t) {
      n.execute("close", e, t)
    }, toggle: function (e, t) {
      n.execute("toggle", e, t)
    }, toogle: function (e, t) {
      n.execute("toggle", e, t)
    }
  };
  e.sidr = function (t) {
    return o[t] ? o[t].apply(this, Array.prototype.slice.call(arguments, 1)) : "function" != typeof t && "string" != typeof t && t ? (e.error("Method " + t + " does not exist on jQuery.sidr"), void 0) : o.toggle.apply(this, arguments)
  }, e.fn.sidr = function (t) {
    var i = e.extend({
      name: "sidr",
      speed: 200,
      side: "left",
      source: null,
      renaming: !0,
      body: "body",
      displace: !0,
      onOpen: function () {
      },
      onClose: function () {
      }
    }, t), s = i.name, a = e("#" + s);
    if (0 === a.length && (a = e("<div />").attr("id", s).appendTo(e("body"))), a.addClass("sidr").addClass(i.side).data({
        speed: i.speed,
        side: i.side,
        body: i.body,
        displace: i.displace,
        onOpen: i.onOpen,
        onClose: i.onClose
      }), "function" == typeof i.source) {
      var r = i.source(s);
      n.loadContent(a, r)
    } else if ("string" == typeof i.source && n.isUrl(i.source))e.get(i.source, function (e) {
      n.loadContent(a, e)
    }); else if ("string" == typeof i.source) {
      var d = "", l = i.source.split(",");
      if (e.each(l, function (t, i) {
          d += '<div class="sidr-inner">' + e(i).html() + "</div>"
        }), i.renaming) {
        var c = e("<div />").html(d);
        c.find("*").each(function (t, i) {
          var o = e(i);
          n.addPrefix(o)
        }), d = c.html()
      }
      n.loadContent(a, d)
    } else null !== i.source && e.error("Invalid Sidr Source");
    return this.each(function () {
      var t = e(this), i = t.data("sidr");
      i || (t.data("sidr", s), "ontouchstart" in document.documentElement ? (t.bind("touchstart", function (e) {
        e.originalEvent.touches[0], this.touched = e.timeStamp
      }), t.bind("touchend", function (e) {
        var t = Math.abs(e.timeStamp - this.touched);
        200 > t && (e.preventDefault(), o.toggle(s))
      })) : t.click(function (e) {
        e.preventDefault(), o.toggle(s)
      }))
    })
  }
})(jQuery);
//scroll top bottom functions
(function () {
  var special = jQuery.event.special,
    uid1 = 'D' + (+new Date()),
    uid2 = 'D' + (+new Date() + 1);

  special.scrollstart =
  {
    setup: function () {
      var timer,
        handler = function (evt) {

          var _self = this,
            _args = arguments;

          if (timer) {
            clearTimeout(timer);
          }
          else {
            evt.type = 'scrollstart';
            //jQuery.event.handle.apply(_self, _args);
          }

          timer = setTimeout(function () {
            timer = null;
          }, special.scrollstop.latency);

        };
      jQuery(this).bind('scroll', handler).data(uid1, handler);
    },
    teardown: function () {
      jQuery(this).unbind('scroll', jQuery(this).data(uid1));
    }
  };

  special.scrollstop =
  {
    latency: 300,
    setup: function () {
      var timer,
        handler = function (evt) {
          var _self = this, _args = arguments;
          if (timer) {
            clearTimeout(timer);
          }
          timer = setTimeout(function () {
            timer = null;
            evt.type = 'scrollstop';
            //jQuery.event.handle.apply(_self, _args);
          }, special.scrollstop.latency);
        };
      jQuery(this).bind('scroll', handler).data(uid2, handler);
    },
    teardown: function () {
      jQuery(this).unbind('scroll', jQuery(this).data(uid2));
    }
  };
})();
//sort & unique an array with 2D array supported
function _sortUnique(arr) {
  var re = [];
  arr.sort(function (a, b) {
    if (a instanceof Array) {
      var mn = Math.min(a.length, b.length);
      for (var i = 0; i < mn; i++)
        if (a[i] != b[i])
          return a[i] < b[i] ? -1 : 1;

      if (a.length != b.length) return a.length < b.length ? -1 : 1;
      return 0;
    }
    else {
      if (a < b)return -1;
      if (a > b)return 1;
      return 0;
    }
  });

  for (var i = 0; i < arr.length; i++) {
    if (i == 0)
      re.push(arr[i]);
    else {
      if (arr[i] instanceof Array) {
        var same = true;
        if (arr[i - 1].length != arr[i].length) same = false;

        for (var j = 0; j < arr[i].length; j++) {
          if (!same) break;
          if (arr[i][j] != arr[i - 1][j]) same = false;
        }
        if (!same) re.push(arr[i]);
      }
      else if (arr[i] != arr[i - 1])
        re.push(arr[i]);
    }
  }
  return re;
}
//delete script tags from code
function deleteScripts(s) {
  var div = document.createElement('div');
  div.innerHTML = s;
  var scripts = div.getElementsByTagName('script');
  var i = scripts.length;
  while (i--) {
    scripts[i].parentNode.removeChild(scripts[i]);
  }
  return div.innerHTML;
}
/* ==================== postContainer event handler START ==================== */
// @param no: post number, -1 for all
function _hidePost(no) {
  no = parseInt(no);
  var select = '';
  if (no != -1) select = '.postContainer[data-no="' + no + '"]';
  else select = '.postContainer';

  $(select).children().each(function () {
    var flg = $(this).hasClass('replyControl') || $(this).hasClass('postInfo');
    if (!flg) {
      $(this).hide();
    }
  });
}
// @param no: post number, -1 for all
function _showPost(no) {
  no = parseInt(no);
  var select = '';
  if (no != -1) select = '.postContainer[data-no="' + no + '"]';
  else select = '.postContainer';

  $(select).children().each(function () {
    var flg = $(this).hasClass('replyControl') | $(this).hasClass('postInfo');
    if (!flg) {
      $(this).show();
    }
  });
}
// show reply number for quick reply
function replyQuoteClick(no) {
  var sel = '.replyQuote';
  if (no != -1) sel = '.postContainer[data-no="' + no + '"] .replyQuote';

  $(sel).click(function (ee) {
    ee.preventDefault();
    var id = $(this).closest('.postContainer').attr('data-no');

    if ($('#quickReply').is(':hidden')) {
      if (recaptcha) grecaptcha.reset(recaptchaWidget);
      $('#quickReply textarea').each(function () {
        $(this).val('');
      });
      $('#quickReply input[type="text"]').each(function () {
        $(this).val('');
      });

      var replyno = $(this).closest('.threadContainer').attr('data-no');
      $('#quickReplyForm input[name="resto"]').val(replyno);
      $('#quickReply .replyHead b').html('Quick Reply &gt;&gt;' + replyno);

      var e = arguments.callee.caller.arguments[0] || window.event;
      var x = e.clientX;
      var y = e.clientY;
      $('#quickReply').css('top', y + 10);
      $('#quickReply').css('left', x + 10);
      $('#quickReply').show();
      _updateCaptcha();
    }

    $('#quickReply textarea').insertAtCaret('>>' + id + '\n');
  });
}
//hide a post
function hidePost(no) {
  var sel = '.replyControl .options';
  if (no != -1) sel = '.postContainer[data-no="' + no + '"] .options';

  $(sel).append('<img title="隱藏回覆" class="switchPost" style="cursor:pointer; width:18px;" src="' + imgOpenClose + '">');

  $(sel + ' .switchPost').click(function () {
    var fa = $(this).closest('.postContainer');
    var hide = false;

    var tmp = fa.find('blockquote').first().is(':visible');
    if (!tmp) hide = true;

    if (hide) {
      _showPost(fa.attr('data-no'));
    }
    else {
      _hidePost(fa.attr('data-no'));
    }
  });
}
//hide a thread
function hideThread(no) {
  if (no == -1)return;
  var flg = $('.postContainer[data-no="' + no + '"]').first().hasClass('opContainer');
  if (!flg) return;
  if (!cfg[5]) return;

  var node = $('.threadContainer[data-no="' + no + '"]').first();
  if (node.children('switchThread').length == 0) {
    var tt = '<img title="隱藏整串" class="switchThread" width="16px" style="cursor:pointer;" src="' + no0 + '">';
    node.prepend(tt);
  }

  var sel = '.threadContainer[data-no="' + no + '"]';
  $(sel + ' .switchThread').click(function () {
    var hide = $(this).next('div').is(':hidden');
    var img = $(this);
    var id = $(this).closest('.threadContainer').attr('data-no');

    if (hide) {
      loadSetting();
      delete banThread[id];
      saveSetting();
      img.attr('src', no0);

      $(this).parent().children('div').each(function () {
        $(this).show();
      });
    }
    else {
      loadSetting();
      if (!banThread[id]) banThread[id] = new Object();
      banThread[id]['ban'] = 1;
      banThread[id]['time'] = new Date().getTime();
      saveSetting();
      img.attr('src', no1);

      $(this).parent().children('div').each(function () {
        $(this).hide();
      });
    }
  });
}
//add expand link "要閱讀所有回應請按下返信連結。"
function showExpandLink(no) {
  if (no == -1)return;
  var flg = $('.postContainer[data-no="' + no + '"]').first().hasClass('opContainer');
  if (!flg)return;

  $('.threadContainer[data-no="' + no + '"] font[color="#707070"]').each(function () {
    var html = $(this).html();
    html = html.replace('要閱讀所有回應請按下返信連結。', '[<a href="" class="expandThread">展開</a>]');
    $(this).html(html);
  });

  $('.threadContainer[data-no="' + no + '"] .expandThread').click(function (e) {
    e.preventDefault();
    var no = $(this).closest('.threadContainer').attr('data-no');
    var url = 'index.php?res=' + no;
    var thread = $(this).closest('.threadContainer');

    $.ajax(
      {
        url: url,
        timeout: ajaxTimeout,
        success: function (data) {
          var rootNode = _loadNewPage(data);
          thread.html(''); //delete all html
          var re = parseAllPost(true, rootNode);
          outputNewPosts(2000000000, re['opHtml'], re['postHtml']);
          $(rootNode).remove();

          //reply link
          var link = '&nbsp;&nbsp;[<a href="index.php?res=' + no + '">返信</a>]';
          $('.postContainer[data-no="' + no + '"] .postInfo').after(link);
        },
        error: function (xhr, text) {
          if (text == 'timeout')
            alert(settingTimeoutText);
        }
      });
  });
}
//filter
function filterPosts(no) {
  if (!cfg[6]) return;
  var sel = '.postContainer';
  if (no != -1) sel = sel + '[data-no="' + no + '"]';

  $(sel + ' blockquote').each(function () {
    var content = $(this).text();
    var flg = false;
    var mat = '';
    for (var i = 0; i < filter.length; i++) {
      if (flg) break;
      //var reg = new RegExp(filter[i], 'g');
      if (content.match(filter[i])) {
        flg = true;

        mat = filter[i];
        if (mat.length > 10) mat = mat.substr(0, 7) + '...';
      }
    }

    if (flg) {
      var node = $(this).closest('.postContainer');
      var no = node.attr('data-no');
      _hidePost(parseInt(no));
      node.find('.postInfo').first().append('&nbsp;已過濾');
    }
  });
}
//hide name and title
function hideNameAndTitle(no) {
  var prefix = '.postInfo';
  if (no != -1) prefix = '.postContainer[data-no="' + no + '"] ' + prefix;
  //hide title
  if (cfg[0]) {
    $(prefix + ' font[color="#cc1105"][size="+1"]').remove();
  }
  //hide name
  if (cfg[1]) {
    $(prefix + ' font[color="#117743"]').remove();
  }
}
//show quote window
var _hoverFunc = function () {
  $('#hidePost').html();

  var id = parseInt($(this).attr('data-no'));
  var from = parseInt($(this).closest('.postContainer').attr('data-no'));
  var e = arguments.callee.caller.arguments[0] || window.event;
  var x = e.clientX;
  var y = e.clientY;

  if (posts[id] !== undefined) {
    $('#hidePost').html(posts[id]);
    $('#hidePost .quoteLink[data-no="' + from + '"]').css('font-weight', 'bold');

    $('#hidePost').css('top', y);
    $('#hidePost').css('left', x + 10);
    $('#hidePost').show();

    var off = document.getElementById('hidePost').offsetHeight / 2;
    if (off > y) off = y;
    $('#hidePost').css('top', y - off);
  }
}
var _unhoverFunc = function () {
  $('#hidePost').hide();
}
function hoverQuoteLinks(no) {
  if (!cfg[3]) return;
  if ($('#hidePost').length == 0)
    $('body').append('<div id="hidePost" style="display:none; position:fixed; border-style:solid; border-width:2px; border-color:#000000; background-color:#F0E0D6; z-index:1000000;"></div>');
  var sel = '.quoteLink';
  if (no != -1) sel = '.postContainer[data-no="' + no + '"] .quoteLink';

  $(sel).hover(_hoverFunc, _unhoverFunc);
}
//click & expand image
function expandImage(no) {
  if (!cfg[2]) return;
  var sel = '.postContainer';
  if (no != -1) sel = sel + '[data-no="' + no + '"]';

  $(sel + ' a').click(function (e) {
    if (!$(this).has('img').length) return;
    if (e.button == 1) return;

    e.preventDefault();
    var url = $(this).attr('href');
    var flg = $(this).has('.expanded').length ? true : false;

    var tmp = '<div class="expanded" style="padding:16px; display:block;"><img class="expanded" style="max-width:100%;  cursor:pointer;" src="' + url + '"></div>';
    $(this).hide();
    $(this).after(tmp);

    $(sel + ' div[class="expanded"] img').click(function (e) {
      $(this).parent().remove();
      $(sel + ' a').each(function () {
        if (!$(this).has('img').length) return;
        $(this).show();
      });
    });
  });
}
//add option switch
function addOptionSwitch(no) {
  var sel = '.postContainer';
  if (no != -1) sel = sel + '[data-no="' + no + '"]';
  $(sel + ' .optionSwitch').click(function () {
    var node = $(this).parent().children('.options');
    if (node.is(':visible')) {
      node.css('display', 'none');
      $(this).attr('src', imgDown);
    }
    else {
      node.css('display', 'inline');
      $(this).attr('src', imgRight);
    }
  });
}
function addGoogleSwitch(no) {
  var sel = '.postContainer';
  if (no != -1) sel = sel + '[data-no="' + no + '"]';

  $(sel).each(function () {
    var hasImg = false;
    var url = '';
    $(this).find('a').each(function () {
      if ($(this).has('img').length) {
        hasImg = true;
        url = $(this).attr('href');
      }
    });

    if (hasImg) {
      $(sel + ' .options').append('<a target="_blank" href="//www.google.com/searchbyimage?image_url=' + url + '"><img title="Google搜圖" class="switchGoogle" src="' + imgGoogle + '"></img>');
    }
  });
}
// @param no: post number, -1 for all posts
// update global var "posts"
function _threadUpdateActions(no) {
  hideNameAndTitle(no);
  posts[no] = $('.postContainer[data-no="' + no + '"]').first().html();

  addOptionSwitch(no);
  hoverQuoteLinks(no);
  hidePost(no);
  hideThread(no);
  showExpandLink(no);
  expandImage(no);
  addGoogleSwitch(no);
  replyQuoteClick(no);
  filterPosts(no);
}
/* ==================== postContainer event handler END ==================== */
//load new page to temp div
//return: div name
function _loadNewPage(data) {
  data = deleteScripts(data);
  var rootNode = '#buffer_upd_' + (new Date().getTime());
  data = data.replace('<img border=1 src="/cap/freecap.php" id="freecap">', '');
  if ($(rootNode).length == 0) $('body').append('<div id="' + rootNode.substr(1) + '" style="display:none;"></div>');

  var all = '';
  var html = $.parseHTML(data);
  var ignore = true;
  for (var i = 0; i < html.length; i++) {
    if ((html[i].nodeName == 'DIV' && html[i].className == "container") || (html[i].nodeName == 'FORM' && html[i].enctype != "multipart/form-data")) {
      ignore = false;
    }
    if (!ignore) {
      if (html[i].nodeName == '#text')
        all += html[i].wholeText;
      else
        all += html[i].outerHTML;
    }
  }

  $(rootNode).html(all);
  moveDOM(rootNode);

  var new_html = $(rootNode).find('form[enctype!="multipart/form-data"][action="index.php"]').first().html();
  $(rootNode).html('');
  $(rootNode).html(new_html);

  return rootNode;
}
//insert & seperate post head
//delete junks before post
//add options
function _htmlInsertReplyControl(html, no, noimg, isOP) {
  var rootNode = '#buffer_' + (new Date().getTime());
  if ($(rootNode).length == 0) $('body').append('<div id="' + rootNode.substr(1) + '" style="display:none;"></div>');
  $(rootNode).html('');
  $(rootNode).html(html);

  $(rootNode + ' input[value="delete"]').each(function () {
    var tmp = $(this).nextUntil('a[class="del"]');
    var d = $(this).parent().find('a[class="del"]');
    if (d.length) d = d[0];

    var head = this.outerHTML;
    for (var i = 0; i < tmp.length; i++)
      head = head + tmp[i].outerHTML;

    try {
      head = head + d.outerHTML;
    } catch (e) {

    }

    var control = '<div style="display:inline;" class="replyControl"><img title="展開選項" style="cursor:pointer;" class="optionSwitch" src="' + imgDown + '"></img><div class="options" style="display:none;"></div></div>';

    if (isOP)//OP
      $(rootNode).prepend(control);
    else//reply
      $(this).before(control);

    $(this).before('<div class="postInfo" style="display:inline;"></div>');

    var div = $(this).parent().find('.postInfo');
    div.html(head);

    $(this).remove();
    tmp.remove();

    //DEBUG HERE
    try {
      d.remove();
    } catch (e) {

    }

    var wrap = $(rootNode);
    var td = wrap.find('td');
    if (td && td.length >= 2)//is reply
    {
      var tmp2 = td[1].innerHTML;
      $(rootNode).html(tmp2);
    }

    var nohtml = $(rootNode + ' .postInfo').html();
    nohtml = nohtml.replace('No.' + no, '<a class="replyQuote" style="cursor:pointer;">No.' + no + '</a>');
    $(rootNode + ' .postInfo').html(nohtml);

    //parse time & ID
    var time = '', id = '', tt = '';
    var ar = [];
    $(rootNode + ' .postInfo span').each(function () {
      //move quoteLink
      $(this).find('a').each(function () {
        $(this).parent().after(this.outerHTML + ' ');
        this.outerHTML = '';
      });

      tt = $(this).html();
      if (tt.match('ID:')) {
        ar = tt.match(/\S+/g);
        if (!ar || ar.length != 2)return;
        time = ar[0];
        id = ar[1];
      }
      else
        return;

      var replace = '<span style="font-size:16px;" class="time">' + time + '</span>';
      replace += ' ';
      replace += '<span style="font-size:16px;" class="id">' + id + '</span> ';

      var del = $(this).html().replace(tt, "");
      $(this).html(del);
      $(this).before(replace);
      $(this).remove();
    });

    //add space after name & title
    $(rootNode + ' .postInfo font').each(function () {
      $(this).after(' ')
    });
  });

  var re = $(rootNode).html();
  $(rootNode).remove();
  return re;
}
//check quotes in reply html
function _htmlQuoteLinks(html, no) {
  var arr = [], tmp;
  var re = html;
  var reg = /((?:&gt;){1,2})\s*(?:[Nn][Oo]){0,1}(?:\.)?\s*(\d+)/gi;
  while (tmp = reg.exec(html)) {
    arr.push(tmp);
  }

  arr = _sortUnique(arr);
  for (var i = 0; i < arr.length; i++) {
    if (posts[parseInt(arr[i][2])] === undefined) continue;
    tmp = '<a href="#r' + arr[i][2] + '" class="quoteLink" style="text-decoration:none;" data-no="' + arr[i][2] + '">' + arr[i][0] + '</a>';

    reg = new RegExp(arr[i][0], "g");
    re = re.replace(reg, tmp);

    var no2 = parseInt(arr[i][2]);
    outputBackQuote(no2, no);
  }
  return re;
}
//if no!=-1, only update new posts
var _updateThread = function (no) {
  if (!cfg[9]) return;
  if (no == -1 && !isReplyPage) return;

  var url = document.URL;
  if (no != -1) url = 'index.php?res=' + no;
  $.ajax(
    {
      url: url,
      ajaxStart: null,
      timeout: ajaxTimeout,
      success: function (data) {
        var cur = idleTime;
        var rootNode = _loadNewPage(data);
        var re = parseAllPost(true, rootNode);
        var postHtml = re['postHtml'];
        var opHtml = re['opHtml'];

        //check deleted posts
        if (no == -1) {
          if (opHtml.length > 0) //check if download success
          {
            $('.replyContainer').each(function () {
              var id = parseInt($(this).attr('data-no'));
              var vis = false;

              for (var i = 0; i < postHtml.length; i++) {
                if (vis) break;
                if (parseInt(postHtml[i].no) == id) vis = true;
              }
              if (!vis) {
                $(this).css('opacity', '0.5');
                $(this).css('-moz-opacity', '0.5');
              }
            });
          }
        }
        else //remove old posts
        {
          var lastid = $('.threadContainer[data-no="' + no + '"] .postContainer').last().attr('data-no');
          lastid = parseInt(lastid);

          var tmp = [];
          for (var i = 0; i < postHtml.length; i++) {
            if (postHtml[i].no > lastid)
              tmp.push(postHtml[i]);
          }
          postHtml = tmp;
          opHtml = [];
        }

        outputNewPosts(cur, opHtml, postHtml);
        $(rootNode).remove();
      }
    });
}
// y quote x
function outputBackQuote(x, y) {
  if (!cfg[4]) return;
  if (!replies[x]) replies[x] = new Object();
  //if( replies[x][y] ) return;
  //replies[x][y] = true;
  var node = '.postContainer[data-no="' + x + '"]';
  if ($(node).length == 0) return;

  if ($(node + ' .backquote').length == 0) {
    $(node + ' blockquote').append('<div class="backquote" style="font-size: 12px; margin-top: 16px;"></div>');
    $(node + ' .backquote').first().html('Replies:');
  }

  var maxID = -1;
  $(node + ' .backquote .quoteLink').each(function () {
    var tmp = parseInt($(this).attr('data-no'));
    if (tmp <= parseInt(y) && maxID < tmp) maxID = tmp;
  });
  if (maxID == parseInt(y)) return;

  var tmp = '&nbsp;&nbsp;<a href="#r' + y + '" class="quoteLink" style="text-decoration:none;" data-no="' + y + '">&gt;&gt;' + y + '</a>';

  if (maxID == -1) {
    $(node + ' .backquote').append(tmp);
  }
  else {
    $(node + ' .backquote .quoteLink[data-no="' + maxID + '"]').after(tmp);
  }
  $(node + ' .quoteLink[data-no="' + y + '"]').hover(_hoverFunc, _unhoverFunc);
}
// Input: opHtml, postHtml, cur(timestamp)
// display all the posts in postHtml, opHtml
// return true if new post founded
// save contents to posts
function outputNewPosts(cur, opHtml, postHtml) {
  //new OPs
  var node = '#threads';
  var new_reply = false;
  for (var i = 0; i < opHtml.length; i++) {
    var id = opHtml[i].no;
    var node2 = '.threadContainer[data-no="' + id + '"]';
    var tmp = '<div class="threadContainer" style="display:block;" data-no="' + id + '"></div><hr style="clear:both;">';
    var tmp2 = '<div id="r' + id + '" class="postContainer opContainer" style="display:inline; overflow:hidden; word-break:break-all;" data-no="' + id + '">' + posts[id] + '</div>';

    //append threadContainer
    if (!$(node2).length) $(node).append(tmp);
    //content exists
    if ($('.postContainer[data-no="' + id + '"]').length) continue;

    new_reply = true;
    posts[id] = opHtml[i].html;
    posts[id] = _htmlQuoteLinks(posts[id], id);
    $(node2).append(tmp2);

    $('.postContainer[data-no="' + id + '"] a img').css('float', 'left').css('margin-bottom', '8px').removeAttr('align');
    $('.postContainer[data-no="' + id + '"] br[clear="left"]').remove();
    $('.postContainer[data-no="' + id + '"] div[class="spacer"]').remove();

    newReplyCount++;
    lastUpdataTime = cur;
    _threadUpdateActions(id);
    //posts[id] = $('.postContainer[data-no="' + id + '"]').first().html();
  }

  //new replies
  for (var i = 0; i < postHtml.length; i++) {
    var id = parseInt(postHtml[i].no);
    var new_flg = $('.replyContainer[data-no="' + id + '"]').length == 0 ? true : false;
    if (!new_flg) continue;

    new_reply = true;
    posts[id] = postHtml[i].html;
    posts[id] = _htmlQuoteLinks(posts[id], id);
    $('.threadContainer[data-no="' + postHtml[i].father + '"]').append('<div id="r' + id + '" class="postContainer replyContainer" style="overflow:hidden; margin:5px; padding:5px; display:table; background-color:#F0E0D6; word-break:break-all;" data-no="' + id + '">' + posts[id] + '</div>');

    newReplyCount++;
    lastUpdateTime = cur;
    _threadUpdateActions(id);
    //posts[id] = $('.postContainer[data-no="' + id + '"]').first().html();
  }

  return new_reply;
}
//output all posts in a new DOM format (first time)
function outputNewDOM() {
  $('body form[enctype!="multipart/form-data"][action="index.php"] hr').each(function () {
    $(this).remove();
  });
  $('body form[enctype!="multipart/form-data"][action="index.php"]').append('<div id="threads"></div>');
  $('body form[enctype!="multipart/form-data"][action="index.php"]').append('<div id="footer">' + lastHtml + '</div>');

  //page link
  $('#footer table[align="left"] input').each(function () {
    var url = $(this).prev('form').attr('action');
    $(this).click(function (e) {
      e.preventDefault();
      window.location.href = $(this).parent().prev('form').attr('action');
    });
  });
}
//show Statistics table
function showStatisticsTable() {
  if (!cfg[10]) return;
  $('#statisticsTime').html('最後更新時間：' + new Date(parseInt(statistics['lastUpdateEnd'])).toString());
  $('#statistics table').html('<thead><tr><th>No.</th><th>發文時間</th><th>最後回覆時間</th><th>回覆數量</th></tr></thead><tbody></tbody>');
  for (var i in statistics) if (parseInt(i) == i) {
    var tt = sprintf('<tr><td><a href="index.php?res=%s" data-no="%s">No.%s</a></td><td>%s</td><td>%s</td><td>%s</td></tr>',
      i,
      i,
      i,
      statistics[i]['firstReply'],
      statistics[i]['lastReply'],
      statistics[i]['replyCount']
    );
    $('.tablesorter tbody').append(tt);
  }

  $(".tablesorter").tablesorter(
    {
      headers: {
        0: {sorter: "text", empty: "top"},
        1: {sorter: "text", empty: "top"},
        2: {sorter: "text", empty: "top"},
        3: {sorter: "numeric", empty: "top"},
      }
    });

  $('#statistics table a').hover(function () {
    var i = $(this).attr('data-no');
    $('#hidePost').html('<div id="_tmpimg"></div><div id="_tmpres"></div>');

    if (statistics[i]['img'] != '')
      $('#_tmpimg').html('<img src="' + statistics[i]['img'] + '">');
    if (statistics[i]['content'] != '')
      $('#_tmpres').html(statistics[i]['content']);

    var e = arguments.callee.caller.arguments[0] || window.event;
    var x = e.clientX;
    var y = e.clientY;
    $('#hidePost').css('top', y);
    $('#hidePost').css('left', x + 10);
    $('#hidePost').show();
    var off = document.getElementById('hidePost').offsetHeight / 2;
    if (off > y) off = y;
    $('#hidePost').css('top', y - off);

  }, function () {
    $('#hidePost').html('');
    $('#hidePost').hide();
  });
}
//show control div
function drawControlPanel() {
  $('body').append('<div id="control" style="position:fixed; cursor:pointer; right:15px; top:15px; width:32px; height:32px; z-index:1000000; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAfUlEQVRYR2NkGGDAOMD2M4w6YDQEkEPAB5ggJwGxIo0T5j2g+blAvA1kD7IDHgH5sjS2HGb8QyBDAd0BT4AC0nRywGOgPXLoDgBFwUwglqKxI54CzU/DFgU0the78aPZcFCFwGg5MFoOjJYDoyEwWg6MlgOjuWA0BEZmCAAAfT8eIbmPUbkAAAAASUVORK5CYII=) no-repeat;"></div>');

  //tab css
  $('head').append('<style>#left{display:none;position:absolute;position:fixed;top:0;height:100%;z-index:999999;width:100%;overflow-x:none;overflow-y:auto;font-size:15px;background:#f8f8f8;color:#333;-webkit-box-shadow:inset 0 0 5px 5px #ebebeb;-moz-box-shadow:inset 0 0 5px 5px #ebebeb;box-shadow:inset 0 0 5px 5px #ebebeb;}ul#tabs{list-style-type:none;margin:30px 0 0;padding:0 0 .3em}ul#tabs li{display:inline}ul#tabs li a{color:#42454a;background-color:#dedbde;border:1px solid #c9c3ba;border-bottom:none;padding:.3em;text-decoration:none}ul#tabs li a:hover{background-color:#f1f0ee}ul#tabs li a.selected{color:#000;background-color:#f1f0ee;font-weight:700;padding:.7em .3em .38em}div.tabContent{border:1px solid #c9c3ba;padding:.5em}div.tabContent.hide{display:none}</style>');
  //table css
  $('head').append('<style>table.tablesorter{font-family:arial;background-color:#CDCDCD;font-size:8pt;width:100%;text-align:left;margin:10px 0 15px;}table.tablesorter thead tr th,table.tablesorter tfoot tr th{background-color:#e6EEEE;border:1px solid #FFF;font-size:8pt;padding:4px;}table.tablesorter thead tr .header{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAJAQMAAADnzfU1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABlBMVEX///8jLTBpOkGEAAAAAXRSTlMAQObYZgAAAAFiS0dEAf8CLd4AAAAfSURBVAhbY2BQYGBgKADiHwwMjH8YwABM/4CKKzAAAFraBQtTZ+M6AAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE0LTA4LTI5VDE4OjQ1OjM3KzAyOjAwVuM0aAAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxNC0wOC0yOVQxODo0NTozNiswMjowMIHJh2AAAAAASUVORK5CYII=);background-repeat:no-repeat;background-position:center right;cursor:pointer;}table.tablesorter tbody td{color:#3D3D3D;background-color:#FFF;vertical-align:top;padding:4px;}table.tablesorter tbody tr.odd td{background-color:#F0F0F6;}table.tablesorter thead tr .headerSortUp{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAEAQMAAABbU+brAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABlBMVEX///8jLTBpOkGEAAAAAXRSTlMAQObYZgAAAAFiS0dEAf8CLd4AAAAVSURBVAhbY2D8w8DA8AOIC4BYgQEAGncChov1FHQAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTQtMDgtMjlUMTg6NDY6MDgrMDI6MDDFE/hhAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE0LTA4LTI5VDE4OjQ2OjA3KzAyOjAwQgYwNAAAAABJRU5ErkJggg==);}table.tablesorter thead tr .headerSortDown{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAEAQMAAABbU+brAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABlBMVEX///8jLTBpOkGEAAAAAXRSTlMAQObYZgAAAAFiS0dEAf8CLd4AAAAVSURBVAjXY2AQYGBgsADiGiD+xwAACAQBw9Al0ZEAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTQtMDgtMjlUMTg6NDU6MDMrMDI6MDAsIxeYAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE0LTA4LTI5VDE4OjQ1OjAyKzAyOjAw+wmkkAAAAABJRU5ErkJggg==);}table.tablesorter thead tr .headerSortDown,table.tablesorter thead tr .headerSortUp{background-color:#8dbdd8;}</style>');

  $('body').append('<div id="left"></div>');
  $('#left').append('<ul id="tabs"><li><a href="#config">設定</a></li><li><a href="#statistics">所有文章統計</a></li></ul><div id="config" class="tabContent"></div><div id="statistics" class="tabContent"></div>');

  $('.tabContent').hide();
  $('.tabContent').first().show();
  $('#tabs a').click(function (e) {
    e.preventDefault();
    var id = $(this).attr('href');
    $('.tabContent').hide();
    $(id).show();
  });

  $('#statistics').append('<div id="statisticsHeader">[<a id="updStatistics" style="cursor:pointer;">點我更新所有文章(約數秒到1,2分鐘不等)</a>]</div><div id="statisticsTime"></div><div id="statisticsMessage"></div>');
  $('#statistics').append('<table class="tablesorter"></table> ');
  $('#updStatistics').click(function (e) {
    e.preventDefault();
    statisticsHandler();
  });


  $('#config').append('<form><ul style="list-style:none;"></ul></form>');
  $('#config ul').append('<li><input type="submit" value="儲存設定"><br></li>');
  for (var i = 0; i < defaultCfg.length; i++) {
    $('#config ul').append('<li><label><input type="checkbox" name="cfg[' + i + ']">' + settingDes[i][0] + '</label></li>');
    $('#config ul').append('<li style="margin-bottom:10px;"><small>' + settingDes[i][1] + '</small></li>');
  }
  $('#config ul').append('<li><label>過濾內容：<small>(一行一條規則)</small><br><textarea name="filter" style="height:300px; width:450px;"></textarea></label></li>');

  $('#config form').submit(function (e) {
    e.preventDefault();

    for (var i = 0; i < defaultCfg.length; i++) {
      var vv = $('#config input[name="cfg[' + i + ']"]').first().prop('checked');
      vv = Boolean(vv);

      if (vv == true) cfg[i] = 1;
      else cfg[i] = 0;
    }

    var ar = $('#config textarea[name="filter"]').first().val().match(/[^\r\n]+/g);
    filter = ar;

    saveSetting();
    if (confirm('儲存成功，要重新整理頁面嗎')) {
      location.reload();
    }
  });

  $('#control').sidr(
    {
      name: 'left',
      side: 'left',
      onOpen: function () {
        loadSetting();
        for (var i = 0; i < defaultCfg.length; i++) {
          var tmp = cfg[i] ? true : false;
          $('#config input[name="cfg[' + i + ']"]').prop('checked', tmp);
        }

        var val = '';
        for (var i = 0; i < filter.length; i++)
          val += filter[i] + '\n';
        $('#config textarea[name="filter"]').val(val);

        showStatisticsTable();
      }
    });
  //$('#control').append('<input type="button" onclick="updateThread();" value="更新" id="refresh-button"/>');
  //$('#control').append('<input type="button" value="設定" id="setting-button"/>');
  //$('#control').append('<input type="button" value="TOP" id="top-button"/>');
  //$('#control').append('<input type="button" value="BOTTOM" id="bottom-button"/>');

}
/* get all posts and thread number
 * OUTPUT: opHtml, postHtml
 */
/**
 * 整理解析HTML
 * */
function parseAllPost(ajax, rootNode) {
  var opHtml = [];
  var postHtml = [];
  var cnt = 0;
  var threadId = 0;

  /**
   * span包裹text 刪除空白行 */
  //add <span> to text nodes
  //　包裹所有純文字內容
  $(rootNode).contents().filter(function () {
      return this.nodeType === 3;
    })
    .wrap('<span class="plain" style="font-size:16px"></span>');
  $(rootNode + ' td').contents().filter(function () {
      return this.nodeType === 3;
    })
    .wrap('<span class="plain" style="font-size:16px"></span>');

  //delete empty nodes
  $('span[class="plain"]').each(function () {
    var tmp = $(this).html();
    tmp = tmp.replace(/\s+/, "");
    tmp = tmp.replace(/(\r\n|\n|\r)/gm, "");
    $(this).html(tmp);
    $(this).removeClass('plain');

    if ($(this).html().length == 0)
      $(this).remove();
  });
  /**
   * 分析［回應］ */
  //parse replies
  //　$( 回應內文 <table> , [刪除] checkbox )
  $(rootNode + '>table[border="0"], ' + rootNode + '>input[value="delete"]').each(function () {
    // <table>.prop("tagName") = table;
    var tagName = $(this).prop("tagName");

    // 如果是 [刪除checkbox] 則 提取 name=ID
    if (tagName == "INPUT") {
      threadId = $(this).attr('name');
      cnt++;
    }
    else {
      var i = $(this).find('input').first().attr('name');
      if (!i)return;

      var html = _htmlInsertReplyControl(this.outerHTML, parseInt(i), false, false);
      var ele =
      {
        'no': parseInt(i),
        'father': parseInt(threadId),
        'html': html
      };

      if (!$('.postContainer[data-no="' + i + '"]').length)
        posts[parseInt(i)] = html;
      postHtml.push(ele);
      $(this).remove();
    }
  });
  if (cnt == 1 && !ajax)isReplyPage = 1;


  //parse OPs
  /** Point
   * Jquery $().nextUntil()
   **/
  $(rootNode). prepend('<hr>');
  $('body ' + rootNode + ' > hr').each(function () {
    var no = 0;
    var html = '';
    var tmp = $(this).nextUntil('hr');
    tmp.find('script').remove();

    for (var i = 0; i < tmp.length; i++) {
      if (tmp[i].tagName == "INPUT" && tmp[i].type == "checkbox" && tmp[i].value == "delete") {
        no = parseInt(tmp[i].name);
      }

      html = html + tmp[i].outerHTML;
    }

    if (no != 0) {
      html = _htmlInsertReplyControl(html, no, false, true);
      var ele =
      {
        no: no,
        father: no,
        html: html,
      };
      opHtml.push(ele);

      if (!$('.postContainer[data-no="' + no + '"]').length)
        posts[no] = html;
      tmp.remove();
    }
    else {
      if (!ajax)lastHtml = html;
      tmp.remove();
    }
  });

  //then, delete hrs
  $(rootNode + ' hr').remove();

  var re = new Object();
  re['postHtml'] = postHtml;
  re['opHtml'] = opHtml;
  return re;
}
// Update page title
var _tick = function () {
  idleTime++;
  if (lastUpdateTime >= idleTime || idleTime == 1) {
    newReplyCount = 0;
  }

  if (newReplyCount == 0)
    document.title = title;
  else
    document.title = '(' + newReplyCount + ') ' + title;
}
function prepareTimer() {
  $(document).mousemove(function (e) {
    idleTime = 0;
  });
  $(document).keypress(function (e) {
    idleTime = 0;
  });
  setInterval(_tick, 100);
}
//update captcha image
function _updateCaptcha() {
  convertImgToBase64('/cap/freecap.php', function (img) {
    $('img[class="freecap"]').each(function () {
      $(this).attr('src', img);
    });
  });
}
/*
 * 1. Add quickReply idv
 * 2. Handle ajax connection
 */
function quickReplyInit() {
  if (!cfg[7]) return;
  //if(!isReplyPage) return;

  if ($('#quickReply').length == 0) {
    $('body').append('<div id="quickReply" style="display: none; position:fixed; z-index:999; background-color:#F0E0D6; border-style:solid; border-width:2px; border-color:#000000;"></div>');
    $('#quickReply').append('<form id="quickReplyForm" action="index.php" method="POST"><div class="replyHead" style="cursor:move; text-align:center; padding:2px;"><b>Quick Reply</b><img class="quickReplyClose" style="float:right; cursor:pointer;" src="' + imgOpen + '"></div></form>');
    $('#quickReply').draggable(
      {
        containment: 'body',
        handle: '.replyHead',
      });

    var html = '';
    $('form[enctype="multipart/form-data"] input[type="hidden"]').each(function () {
      html = html + this.outerHTML;
    });
    $('#quickReplyForm').append(html);

    $('form[enctype="multipart/form-data"] tr').each(function () {
      if ($(this).hasClass('hide')) return;
      if ($(this).find('td').length < 2) return;

      if ($(this).find('td').eq(1).find('.g-recaptcha').length > 0) return; //avoid duplicate
      var des = $(this).find('td').eq(0).text();
      var html = $(this).find('td').eq(1).html();
      $('#quickReplyForm').append('<div style="width:100%">' + html + '</div>')
      $('#quickReply div:last input[type="text"]').first().attr('placeholder', des);
      $('#quickReply div:last textarea').first().attr('placeholder', des);
    });


    //let me load captcha for you~
    if ($('form[enctype="multipart/form-data"] tr .g-recaptcha').length > 0) {
      recaptcha = true;
      var sitekey = $('form[enctype="multipart/form-data"] tr .g-recaptcha').first().attr('data-sitekey');
      $('#quickReplyForm').append('<div id="quickReplyCaptcha" data-sitekey="' + sitekey + '"></div>');
      recaptchaWidget = grecaptcha.render('quickReplyCaptcha',
        {
          'sitekey': sitekey
        });
    }

    if (!$('#quickReplyForm input[name="resto"]').length)
      $('#quickReplyForm').append('<input type="hidden" name="resto" value="">');

    $('#quickReply textarea').first().attr('cols', '').css('width', '100%');
    $('#quickReply input[type!="submit"]').attr('size', '').css('width', 'auto');
  }

  $('#quickReply .quickReplyClose').click(function () {
    $('#quickReply').hide();
  });

  $('#quickReplyForm').submit(function (e) {
    e.preventDefault();
    var d = new FormData(this);
    var url = $(this).attr('action');
    var replyto = $(this).find('input[name="resto"]').first().val();

    $.ajax(
      {
        url: url,
        data: d,
        type: 'POST',
        mimeType: "multipart/form-data",
        contentType: false,
        cache: false,
        processData: false,
        timeout: ajaxTimeout,
        beforeSend: function (xhr) {
          $.removeCookie('PHPSESSID', {path: '/'});
        },
        success: function (data) {
          while (data.length && data[0] != '<') data = data.substr('1');
          data = data.replace('<img border=1 src="/cap/freecap.php" id="freecap">', '');

          var msg = $(data).find('font[size="5"]');
          var err = '';
          $(msg).find('a').remove();

          for (var i = 0; i < msg.length; i++) {
            if (msg[i].color == "red") {
              err = msg[i].textContent;
              break;
            }
          }

          if (err != '') {
            _updateCaptcha();
            alert(err);
            if (recaptcha) grecaptcha.reset(recaptchaWidget);
          }
          else {
            $('#quickReply').hide();
            _updateThread(replyto);
          }
        },
        error: function (xhr, text) {
          if (text == 'timeout')
            alert(settingTimeoutText);
          else
            alert('連線失敗');

          if (recaptcha) grecaptcha.reset(recaptchaWidget);
        }
      });
  });
}
//add top & bottom button
function topAndBottom() {
  if (!cfg[11]) return;
  $('body').append('<div style="display:none;padding:7px;background-color:white;border:1px solid #CCC;position:fixed;background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjM2qefiJQAAAPpJREFUOE+1krGKhEAMhrfaZ7rHEUQsBLEQC0EsLAQFrbQQLMRORERETg8RQcGrjiuPfZAt/50MbL3Owg2kGfJ9SUgul/98TdN8V1W1vVWDwb/DMICiLMuf0xIGXuu6vhF4HAf2fQf7Q5Zlf2maXl+KGPzF2r73fc9hiq7rkCTJPY7jz5eCZ0JRFNi2Deu6Is9zRFH0cRqmRNYyh5dlQRiGEIIpmc2LeZ4xTRN83xcXsHk5PI4jXNcVFwRBwFdIYdu2uMDzPNAmaAOmaYoLHMfhcNu20HVdXGBZFofpiFRVFRcYhgF2VDwURREXaJrGK8uyDEmSxAVnD+cBIAGvqSxTMvUAAAAASUVORK5CYII=) no-repeat top left;background-position:50% 50%;width:20px;height:20px;bottom:10px;opacity:0.7;right:30px;white-space:nowrap;cursor: pointer;-moz-border-radius: 3px 3px 3px 3px;-webkit-border-top-left-radius:3px;-webkit-border-top-right-radius:3px;-khtml-border-top-left-radius:3px;-khtml-border-top-right-radius:3px;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=70);" class="nav_up" id="nav_up"></div>');
  $('body').append('<div style="display:none;padding:7px;background-color:white;border:1px solid #CCC;position:fixed;background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjM2qefiJQAAAPpJREFUOE+1krFqhUAQRV/1vimfI4gIVhZWNiIigoKChaCNiAhiISIi0SAiKGgVUoZ8yCtvnIVAuucGsnC7PWdmZ+d2+69T1zUoVVWhLEtw1yH4OA6WPM/5BVR533ds24Y0TfkFRVEwmBLHMb8gyzKs64plWRCGIb8gSRIGz/MMz/P4BVEUYZomjOMIx3H4BUEQMHgYBhiGwS9wXRd937Pous4nOFt+8X0fXdehbVtomnZdcMKvpmk+6O8JbpoG1I2iKA9Zlt+ebuT53vvZ8ifNgGDaSNu2IUnSlyAI96eCnwuqqr7T9C3LIvjjMvj74tnyKori8Sf4KvQNl5WtDBSZZFQAAAAASUVORK5CYII=) no-repeat top left;background-position:50% 50%;width:20px;height:20px;bottom:10px;opacity:0.7;right:70px;white-space:nowrap;cursor: pointer;-moz-border-radius: 3px 3px 3px 3px;-webkit-border-top-left-radius:3px;-webkit-border-top-right-radius:3px;-khtml-border-top-left-radius:3px;-khtml-border-top-right-radius:3px;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=70);" class="nav_down" id="nav_down"></div>');
  var $elem = $('body');
  $('#nav_up').fadeIn('slow');
  $('#nav_down').fadeIn('slow');
  $(window).bind('scrollstart', function () {
    $('#nav_up,#nav_down').stop().animate({'opacity': '0.2'});
  });
  $(window).bind('scrollstop', function () {
    $('#nav_up,#nav_down').stop().animate({'opacity': '1'});
  });
  $('#nav_down').click(function (e) {
    $('html, body').animate({scrollTop: $elem.height()}, 800);
  });
  $('#nav_up').click(function (e) {
    $('html, body').animate({scrollTop: '0px'}, 800);
  });
}
//hide captcha
function hideCaptcha() {
  if (!cfg[8]) return;
  $('#freecap').each(function () {
    $(this).addClass('freecap');
    $(this).removeAttr('id', '');
  });

  ///////////////////////////////////
  $('form[enctype="multipart/form-data"] tr').each(function () {
    if ($(this).hasClass('hide')) return;
    if ($(this).find('td').length < 2) return;


    var node = $(this).find('td').eq(1);
    if (node.find('.freecap').length)
      $(this).remove();
  });
}
function loadSetting() {
  var loc = window.location.pathname;
  var dir = loc.substring(1, loc.lastIndexOf('/'));

  try {
    cfg = $.parseJSON(localStorage['cfg'].toString());
  }
  catch (e) {
    cfg = defaultCfg;
  }
  if (!cfg) cfg = defaultCfg;

  try {
    filter = $.parseJSON(localStorage['filter'].toString());
  }
  catch (e) {
    filter = [];
  }
  if (!filter) filter = [];

  try {
    banThread = $.parseJSON(localStorage['banThread'].toString());

    if (banThread[dir]) banThread = banThread[dir];
    else banThread = new Object();
  }
  catch (e) {
    banThread = new Object();
  }
  if (!banThread) banThread = new Object();

  try {
    statistics = $.parseJSON(localStorage['statistics'].toString());

    if (statistics[dir]) statistics = statistics[dir];
    else statistics = new Object();
  }
  catch (e) {
    statistics = new Object();
  }

  saveSetting();
}
//only save filter & cfg (no banThread)
function saveSetting() {
  var loc = window.location.pathname;
  var dir = loc.substring(1, loc.lastIndexOf('/'));

  localStorage['cfg'] = JSON.stringify(cfg);
  localStorage['filter'] = JSON.stringify(filter);

  try {
    _sta = $.parseJSON(localStorage['statistics'].toString());
    if (!_sta) _sta = new Object();
  }
  catch (e) {
    _sta = new Object();
  }
  _sta[dir] = statistics;
  for (var i in _sta) {
    if (parseInt(i) != i)
      continue;
    if (parseInt(i) > 100)
      delete _sta[i];
  }

  localStorage['statistics'] = JSON.stringify(_sta);

  try {
    _ban = $.parseJSON(localStorage['banThread'].toString());
    if (!_ban) _ban = new Object();
  }
  catch (e) {
    _ban = new Object();
  }
  _ban[dir] = banThread;
  for (var i in _ban) {
    if (parseInt(i) != i)
      continue;
    if (parseInt(i) > 100)
      delete _ban[i];
  }

  localStorage['banThread'] = JSON.stringify(_ban);
}
//expand all page
function expandAllPage(page, link) {
  $.ajax(
    {
      url: page,
      //async: false,
      timeout: ajaxTimeout,
      success: function (data) {
        var rootNode = _loadNewPage(data);
        var re = parseAllPost(true, rootNode);
        outputNewPosts(2000000000, re['opHtml'], re['postHtml']);
        $(rootNode).remove();

        link.outerHTML = link.innerHTML;
      },
      error: function (xhr, text) {
        if (text == 'timeout')
          alert(settingTimeoutText);
      }
    });
}
//add expand link
function addExpandLink() {
  $('#footer table[align="left"] a').each(function () {
    var href = $(this).attr('href');
    var cont = $(this).html();

    $(this).after('&nbsp;&nbsp;<a class="expandPage" href="' + href + '">展開</a>')
  });
  $('.expandPage').click(function (e) {
    e.preventDefault();
    expandAllPage($(this).attr('href'), this);
  });
}
//statistics holder
function statisticsHandler() {
  if (!cfg[10]) return;
  loadSetting();
  statistics['lastUpdateStart'] = new Date().getTime();
  saveSetting();
  $('#statisticsMessage').html('開始更新...<br>');

  var mx = 10;
  var result = new Object();
  result['page'] = 0;
  for (var i = 0; i <= mx; i++) {
    var url = i + '.htm';
    if (i == 0) url = 'index.htm';

    $.ajax(
      {
        url: url,
        //async: false,
        timeout: ajaxTimeout,
        ajaxStart: null,
        complete: function () {
          result['page']++;
          $('#statisticsMessage').append(this.url + ' 統計完成<br>');

          //all page done
          if (result['page'] == mx + 1) {
            loadSetting();
            $('#statisticsMessage').append('儲存資料中...<br>');
            for (var k in result) if (parseInt(k) == k) //is integer
            {
              var cnt = 0;
              if (statistics[k]) cnt = statistics[k]['failCount'];
              statistics[k] = result[k];
              statistics[k]['failCount'] = cnt;
            }
            for (var k in statistics) if (parseInt(k) == k) {
              if (!result[k]) {
                statistics[k]['failCount']++;
                //if( statistics[k]['failCount']>=5 ) //delete it if fail 5 times
                delete statistics[k];
              }
            }
            saveSetting();
            $('#statisticsMessage').html('');
            showStatisticsTable();
          }
        },
        success: function (data) {
          var rootNode = _loadNewPage(data);
          var re = parseAllPost(true, rootNode);
          for (var i = 0; i < re['opHtml'].length; i++) {
            var no = re['opHtml'][i].no;
            no = parseInt(no);
            re['opHtml'][i].html = _htmlInsertReplyControl(re['opHtml'][i].html, no, true, true);
            $(rootNode).html('');
            $(rootNode).html(re['opHtml'][i].html);

            if (!result[no]) result[no] =
            {
              failCount: 0,
              replyCount: 1,
              firstReply: '',
              lastReply: '',
              content: '',
              img: '',
            };

            $(rootNode + ' font[color="#707070"]').each(function () {
              var text = $(this).html();
              var reg = /回應有(\d+)篇被省略。/g;
              if (x = reg.exec(text)) {
                var cnt = parseInt(x[1]);
                result[no]['replyCount'] += cnt;
              }
            });

            //get reply time
            var time = $(rootNode + ' .time').first().html();
            if (!time) time = '';
            result[re['opHtml'][i].father]['firstReply'] = time;
            result[re['opHtml'][i].father]['lastReply'] = time;

            //get content
            var content = $(rootNode + ' blockquote').first().html();
            if (!content) content = '';
            result[re['opHtml'][i].father]['content'] = content;

            var img = $(rootNode + ' a[target="_blank"] img[align="left"]').first().attr('src');
            if (!img) img = '';
            result[re['opHtml'][i].father]['img'] = img;
          }
          for (var i = 0; i < re['postHtml'].length; i++) {
            var no = re['postHtml'][i].no;
            no = parseInt(no);
            re['postHtml'][i].html = _htmlInsertReplyControl(re['postHtml'][i].html, no, true, false);
            $(rootNode).html('');
            $(rootNode).html(re['postHtml'][i].html);

            //get reply time
            var time = $(rootNode + ' .time').first().html();
            if (!time) time = '';
            result[re['postHtml'][i].father]['lastReply'] = time;

            result[re['postHtml'][i].father]['replyCount']++;
          }

          statistics['lastUpdateEnd'] = new Date().getTime();
          saveSetting();
          $(rootNode).remove();
        }
      });
  }
}
//default ban
function defaultBanThread() {
  if (!cfg[5]) return;
  loadSetting();
  for (var id in banThread) {
    if (banThread[id]['ban'] != 1 && banThread[id]['ban'] != '1') continue;
    $('.threadContainer[data-no="' + id + '"]').each(function () {
      $(this).children('.switchThread').each(function () {
        $(this).attr('src', no1);
      });

      $(this).children('div').each(function () {
        $(this).hide();
      });
    });
  }

  for (var id in banThread) {
    if (banThread[id]['ban'] != 1 && banThread[id]['ban'] != '1') {
      delete banThread[id];
    }

    var diff = new Date().getTime() - parseInt(banThread['time']);
    if (diff > 100 * 86400 * 1000) //100 days
    {
      delete banThread[id];
    }
  }
  saveSetting();
}
function moveDOM(rootNode) {
  //move "題名一覧"
  if ($(rootNode + ' .container').length) {
    if ($(rootNode + ' .container table').length >= 2 && $(rootNode + ' .container table').eq(0).attr('width') == '100%') {
      var tb0 = $(rootNode + ' .container table').eq(0);
      var tb1 = $(rootNode + ' .container table').eq(1);
      $(rootNode + ' .container').prepend('<hr>');
      $(rootNode + ' .container').prepend(tb1[0].outerHTML);
      $(rootNode + ' .container').prepend(tb0[0].outerHTML);
      tb0.remove();
      tb1.remove();
    }

    $(rootNode).contents().filter(function () {
        return this.nodeType === 3;
      })
      .wrap('<span style="font-size:16px"></span>');
    //delete empty nodes
    $(rootNode + ' span').each(function () {
      var tmp = $(this).html();
      tmp = tmp.replace(/\s+/, "");
      tmp = tmp.replace(/(\r\n|\n|\r)/gm, "");
      $(this).html(tmp);

      if ($(this).html().length == 0)
        $(this).remove();
    });

    var full = $(rootNode + ' .container').nextUntil('body');
    var add = '';
    full.each(function () {
      add += this.outerHTML;
    });
    add = deleteScripts(add);
    $(rootNode + ' form[enctype!="multipart/form-data"][action="index.php"]').append(add);
    full.remove();
  }
}
(function () {
  $(document).on(
    {
      ajaxStart: function () {
        $('html,body').css('cursor', 'wait');
      },
      ajaxStop: function () {
        $('html,body').css('cursor', 'default');
      }
    });

  $('input[name="MAX_FILE_SIZE"]').val('10000000');
  $('form').submit(function () {
    $.removeCookie('PHPSESSID', {path: '/'});
  });

  loadSetting();
  moveDOM('body');
  var re = parseAllPost(false, 'form[enctype!="multipart/form-data"][action="index.php"]');
  outputNewDOM();
  outputNewPosts(2000000000, re['opHtml'], re['postHtml']);

  drawControlPanel();
  hideCaptcha();
  quickReplyInit();
  topAndBottom();
  prepareTimer();
  setInterval(function () {
    _updateThread(-1);
  }, 60000);
  addExpandLink();
  defaultBanThread();


}());
